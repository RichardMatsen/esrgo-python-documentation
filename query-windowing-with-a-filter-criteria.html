<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Query Windowing with a Filter Criteria | C# Interface port to Python</title>
    <meta name="description" content="C# Interface port to Python">
    
    
    <link rel="preload" href="/esrgo-python-documentation/assets/css/styles.08b8ebf7.css" as="style"><link rel="preload" href="/esrgo-python-documentation/assets/js/app.08b8ebf7.js" as="script"><link rel="preload" href="/esrgo-python-documentation/assets/js/15.123c7fb9.js" as="script"><link rel="preload" href="/esrgo-python-documentation/assets/css/5.styles.92ce2759.css" as="style"><link rel="preload" href="/esrgo-python-documentation/assets/js/5.92ce2759.js" as="script"><link rel="prefetch" href="/esrgo-python-documentation/assets/css/1.styles.dacdc8f1.css"><link rel="prefetch" href="/esrgo-python-documentation/assets/js/1.dacdc8f1.js"><link rel="prefetch" href="/esrgo-python-documentation/assets/css/2.styles.6df4aee8.css"><link rel="prefetch" href="/esrgo-python-documentation/assets/js/2.6df4aee8.js"><link rel="prefetch" href="/esrgo-python-documentation/assets/css/3.styles.62e3bade.css"><link rel="prefetch" href="/esrgo-python-documentation/assets/js/3.62e3bade.js"><link rel="prefetch" href="/esrgo-python-documentation/assets/js/4.e0e8277f.js"><link rel="prefetch" href="/esrgo-python-documentation/assets/js/6.b3d7e6cd.js"><link rel="prefetch" href="/esrgo-python-documentation/assets/js/7.fcd4ff92.js"><link rel="prefetch" href="/esrgo-python-documentation/assets/js/8.3d242c4d.js"><link rel="prefetch" href="/esrgo-python-documentation/assets/js/9.234d134d.js"><link rel="prefetch" href="/esrgo-python-documentation/assets/js/10.fb3d3e85.js"><link rel="prefetch" href="/esrgo-python-documentation/assets/js/11.d1c152da.js"><link rel="prefetch" href="/esrgo-python-documentation/assets/js/12.db983685.js"><link rel="prefetch" href="/esrgo-python-documentation/assets/js/13.542e130d.js"><link rel="prefetch" href="/esrgo-python-documentation/assets/js/14.bf07540b.js"><link rel="prefetch" href="/esrgo-python-documentation/assets/js/16.8c7136bb.js"><link rel="prefetch" href="/esrgo-python-documentation/assets/js/17.4bf3763a.js"><link rel="prefetch" href="/esrgo-python-documentation/assets/js/18.19d247d1.js"><link rel="prefetch" href="/esrgo-python-documentation/assets/js/19.a9221979.js">
    <link rel="stylesheet" href="/esrgo-python-documentation/assets/css/5.styles.92ce2759.css"><link rel="stylesheet" href="/esrgo-python-documentation/assets/css/styles.08b8ebf7.css"><link rel="stylesheet" href="/esrgo-python-documentation/assets/css/1.styles.dacdc8f1.css"><link rel="stylesheet" href="/esrgo-python-documentation/assets/css/2.styles.6df4aee8.css"><link rel="stylesheet" href="/esrgo-python-documentation/assets/css/3.styles.62e3bade.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/esrgo-python-documentation/" class="home-link router-link-active"><!----> <span class="site-name">C# Interface port to Python</span></a> <div class="links" style="max-width:nullpx;"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/esrgo-python-documentation/" class="nav-link">Overview</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">Domain Model</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/esrgo-python-documentation/domain-generation.html" class="nav-link">Domain Model Code Generation</a></li><li class="dropdown-item"><!----> <a href="/esrgo-python-documentation/serializing-objects.html" class="nav-link">Serializing Objects in Correct Order</a></li><li class="dropdown-item"><!----> <a href="/esrgo-python-documentation/initializing-model-classes.html" class="nav-link">Initializing Model Classes</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">Processing</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/esrgo-python-documentation/commands.html" class="nav-link">Commands</a></li><li class="dropdown-item"><!----> <a href="/esrgo-python-documentation/csv-processing.html" class="nav-link">CSV Processing</a></li><li class="dropdown-item"><!----> <a href="/esrgo-python-documentation/file-handling-with-regex.html" class="nav-link">File Handling with Regex</a></li><li class="dropdown-item"><!----> <a href="/esrgo-python-documentation/logging-with-xml-serialization.html" class="nav-link">Logging with XML Serialization</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">SqlAlchemy</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/esrgo-python-documentation/extracting-data-with-sqlalchemy.html" class="nav-link">Extracting Data with SqlAlchemy ORM</a></li><li class="dropdown-item"><!----> <a href="/esrgo-python-documentation/query-windowing-with-sqlalchemy.html" class="nav-link">Query Windowing with SqlAlchemy ORM</a></li><li class="dropdown-item"><!----> <a href="/esrgo-python-documentation/query-windowing-with-a-filter-criteria.html" class="nav-link router-link-exact-active router-link-active">Query Windowing with a Filter Criteria</a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/esrgo-python-documentation/" class="nav-link">Overview</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">Domain Model</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/esrgo-python-documentation/domain-generation.html" class="nav-link">Domain Model Code Generation</a></li><li class="dropdown-item"><!----> <a href="/esrgo-python-documentation/serializing-objects.html" class="nav-link">Serializing Objects in Correct Order</a></li><li class="dropdown-item"><!----> <a href="/esrgo-python-documentation/initializing-model-classes.html" class="nav-link">Initializing Model Classes</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">Processing</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/esrgo-python-documentation/commands.html" class="nav-link">Commands</a></li><li class="dropdown-item"><!----> <a href="/esrgo-python-documentation/csv-processing.html" class="nav-link">CSV Processing</a></li><li class="dropdown-item"><!----> <a href="/esrgo-python-documentation/file-handling-with-regex.html" class="nav-link">File Handling with Regex</a></li><li class="dropdown-item"><!----> <a href="/esrgo-python-documentation/logging-with-xml-serialization.html" class="nav-link">Logging with XML Serialization</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">SqlAlchemy</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/esrgo-python-documentation/extracting-data-with-sqlalchemy.html" class="nav-link">Extracting Data with SqlAlchemy ORM</a></li><li class="dropdown-item"><!----> <a href="/esrgo-python-documentation/query-windowing-with-sqlalchemy.html" class="nav-link">Query Windowing with SqlAlchemy ORM</a></li><li class="dropdown-item"><!----> <a href="/esrgo-python-documentation/query-windowing-with-a-filter-criteria.html" class="nav-link router-link-exact-active router-link-active">Query Windowing with a Filter Criteria</a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><div class="sidebar-group first"><p class="sidebar-heading open"><span>Query Windowing with a Filter Criteria</span> <!----></p> <ul class="sidebar-group-items"><li><a href="/esrgo-python-documentation/query-windowing-with-a-filter-criteria.html#adding-a-where-clause-to-the-base-query" class="sidebar-link">Adding a WHERE clause to the Base Query</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/esrgo-python-documentation/query-windowing-with-a-filter-criteria.html#pass-an-optional-table-filter" class="sidebar-link">Pass an optional table_filter</a></li><li class="sidebar-sub-header"><a href="/esrgo-python-documentation/query-windowing-with-a-filter-criteria.html#apply-it-to-the-interval-query" class="sidebar-link">Apply it to the interval query</a></li><li class="sidebar-sub-header"><a href="/esrgo-python-documentation/query-windowing-with-a-filter-criteria.html#the-resulting-sql-with-and-without-a-filter-widget-example" class="sidebar-link">The resulting SQL with and without a filter (Widget example)</a></li></ul></li></ul></div></li></ul> </div> <div class="page"> <div class="content"><h1 id="query-windowing-with-a-filter-criteria"><a href="#query-windowing-with-a-filter-criteria" aria-hidden="true" class="header-anchor">#</a> Query Windowing with a Filter Criteria</h1> <h2 id="adding-a-where-clause-to-the-base-query"><a href="#adding-a-where-clause-to-the-base-query" aria-hidden="true" class="header-anchor">#</a> Adding a WHERE clause to the Base Query</h2> <p>This question https://groups.google.com/forum/#!topic/sqlalchemy/d6JJ4z1hQyo highlighted a very good point about the WindowedRangeQuery recipe, that is the interval query acts on the whole table and ignores WHERE clauses applied to the base query. It turns out this is quite easy to change.</p> <h3 id="pass-an-optional-table-filter"><a href="#pass-an-optional-table-filter" aria-hidden="true" class="header-anchor">#</a> Pass an optional table_filter</h3> <p>To start with, add an additional optional parameter to the QueryWindow constructor:</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">class</span> <span class="token class-name">QueryWindow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> query<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> window_size<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> break_column<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span>
                 table_filter<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>query <span class="token operator">=</span> query
        <span class="token keyword">if</span> break_column <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
            break_column <span class="token operator">=</span> self<span class="token punctuation">.</span>get_primary_key<span class="token punctuation">(</span>query<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>break_column <span class="token operator">=</span> break_column
        self<span class="token punctuation">.</span>window_size <span class="token operator">=</span> window_size
        self<span class="token punctuation">.</span>intervals <span class="token operator">=</span> <span class="token boolean">None</span>
        self<span class="token punctuation">.</span><span class="token builtin">filter</span> <span class="token operator">=</span> table_filter
</code></pre></div><h3 id="apply-it-to-the-interval-query"><a href="#apply-it-to-the-interval-query" aria-hidden="true" class="header-anchor">#</a> Apply it to the interval query</h3> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">def</span> <span class="token function">_get_intervals</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
    q <span class="token operator">=</span> self<span class="token punctuation">.</span>_get_interval_query<span class="token punctuation">(</span><span class="token punctuation">)</span>
    interval_starts <span class="token operator">=</span> <span class="token punctuation">[</span>start_value <span class="token keyword">for</span> start_value<span class="token punctuation">,</span> <span class="token keyword">in</span> q<span class="token punctuation">]</span>
    self<span class="token punctuation">.</span>intervals <span class="token operator">=</span> <span class="token punctuation">[</span>QueryWindowInterval<span class="token punctuation">(</span>self<span class="token punctuation">.</span>query<span class="token punctuation">,</span> self<span class="token punctuation">.</span>break_column<span class="token punctuation">,</span> start<span class="token punctuation">,</span> end<span class="token punctuation">)</span>
                      <span class="token keyword">for</span> start<span class="token punctuation">,</span> end <span class="token keyword">in</span> <span class="token builtin">zip</span><span class="token punctuation">(</span>interval_starts<span class="token punctuation">,</span> interval_starts<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">]</span>  
                      <span class="token operator">+</span> <span class="token punctuation">[</span><span class="token boolean">None</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">]</span>

<span class="token keyword">def</span> <span class="token function">_get_interval_query</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
    session <span class="token operator">=</span> self<span class="token punctuation">.</span>query<span class="token punctuation">.</span>session
    q <span class="token operator">=</span> session<span class="token punctuation">.</span>query<span class="token punctuation">(</span>self<span class="token punctuation">.</span>break_column<span class="token punctuation">,</span>
                      func<span class="token punctuation">.</span>row_number<span class="token punctuation">(</span><span class="token punctuation">)</span>
                      <span class="token punctuation">.</span>over<span class="token punctuation">(</span>order_by<span class="token operator">=</span>self<span class="token punctuation">.</span>break_column<span class="token punctuation">)</span>
                      <span class="token punctuation">.</span>label<span class="token punctuation">(</span><span class="token string">'rownum'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> self<span class="token punctuation">.</span><span class="token builtin">filter</span> <span class="token keyword">is</span> <span class="token operator">not</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
        q <span class="token operator">=</span> q<span class="token punctuation">.</span><span class="token builtin">filter</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span><span class="token builtin">filter</span><span class="token punctuation">)</span>
    q <span class="token operator">=</span> q<span class="token punctuation">.</span>from_self<span class="token punctuation">(</span>self<span class="token punctuation">.</span>break_column<span class="token punctuation">)</span>
    <span class="token keyword">if</span> self<span class="token punctuation">.</span>window_size <span class="token operator">&gt;</span> <span class="token number">1</span><span class="token punctuation">:</span>
        q <span class="token operator">=</span> q<span class="token punctuation">.</span><span class="token builtin">filter</span><span class="token punctuation">(</span><span class="token string">&quot;rownum %% %d=1&quot;</span> <span class="token operator">%</span> self<span class="token punctuation">.</span>window_size<span class="token punctuation">)</span>
    <span class="token keyword">return</span> q
</code></pre></div><p>Note that _get_intervalquery is split off from _get_intervals, to allow checking of the SQL statement in tests.</p> <h3 id="the-resulting-sql-with-and-without-a-filter-widget-example"><a href="#the-resulting-sql-with-and-without-a-filter-widget-example" aria-hidden="true" class="header-anchor">#</a> The resulting SQL with and without a filter (Widget example)</h3> <p>In SqlAlchemy the filter expression can be stated directly:</p> <div class="language-python extra-class"><pre class="language-python"><code>table_filter <span class="token operator">=</span> Widget<span class="token punctuation">.</span><span class="token builtin">id</span> <span class="token operator">&lt;</span> <span class="token number">5000</span>
</code></pre></div><p><strong>SQL statement with filter</strong></p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">SELECT</span> anon_1<span class="token punctuation">.</span>widget_id 
<span class="token keyword">FROM</span> <span class="token punctuation">(</span>
    <span class="token keyword">SELECT</span> widget<span class="token punctuation">.</span>id <span class="token keyword">AS</span> widget_id<span class="token punctuation">,</span> row_number<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">OVER</span> <span class="token punctuation">(</span><span class="token keyword">ORDER</span> <span class="token keyword">BY</span> widget<span class="token punctuation">.</span>id<span class="token punctuation">)</span> <span class="token keyword">AS</span> rownum 
    <span class="token keyword">FROM</span> widget
    <span class="token keyword">WHERE</span> widget<span class="token punctuation">.</span>id <span class="token operator">&lt;</span> :id_1
  <span class="token punctuation">)</span> <span class="token keyword">AS</span> anon_1
<span class="token keyword">WHERE</span> rownum <span class="token operator">%</span> <span class="token number">1000</span><span class="token operator">=</span><span class="token number">1</span>
</code></pre></div><p><strong>SQL statement without filter</strong></p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">SELECT</span> anon_1<span class="token punctuation">.</span>widget_id 
<span class="token keyword">FROM</span> <span class="token punctuation">(</span>
    <span class="token keyword">SELECT</span> widget<span class="token punctuation">.</span>id <span class="token keyword">AS</span> widget_id<span class="token punctuation">,</span> row_number<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">OVER</span> <span class="token punctuation">(</span><span class="token keyword">ORDER</span> <span class="token keyword">BY</span> widget<span class="token punctuation">.</span>id<span class="token punctuation">)</span> <span class="token keyword">AS</span> rownum
    <span class="token keyword">FROM</span> widget
  <span class="token punctuation">)</span> <span class="token keyword">AS</span> anon_1
<span class="token keyword">WHERE</span> rownum <span class="token operator">%</span> <span class="token number">1000</span><span class="token operator">=</span><span class="token number">1</span>
</code></pre></div><div class="minimap-container" style="width:250px;" data-v-5674b532><div class="minimap" style="top:250px;zoom:25%;" data-v-5674b532><div data-v-5674b532></div></div></div></div> <div class="page-edit"><!----> <!----></div> <!----> </div> <!----></div></div>
    <script src="/esrgo-python-documentation/assets/js/15.123c7fb9.js" defer></script><script src="/esrgo-python-documentation/assets/js/5.92ce2759.js" defer></script><script src="/esrgo-python-documentation/assets/js/app.08b8ebf7.js" defer></script>
  </body>
</html>
