<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Serializing Objects in Correct Order | C# Interface port to Python</title>
    <meta name="description" content="C# Interface port to Python">
    
    
    <link rel="preload" href="/esrgo-python-documentation/assets/css/styles.08b8ebf7.css" as="style"><link rel="preload" href="/esrgo-python-documentation/assets/js/app.08b8ebf7.js" as="script"><link rel="preload" href="/esrgo-python-documentation/assets/js/17.4bf3763a.js" as="script"><link rel="preload" href="/esrgo-python-documentation/assets/css/5.styles.92ce2759.css" as="style"><link rel="preload" href="/esrgo-python-documentation/assets/js/5.92ce2759.js" as="script"><link rel="prefetch" href="/esrgo-python-documentation/assets/css/1.styles.dacdc8f1.css"><link rel="prefetch" href="/esrgo-python-documentation/assets/js/1.dacdc8f1.js"><link rel="prefetch" href="/esrgo-python-documentation/assets/css/2.styles.6df4aee8.css"><link rel="prefetch" href="/esrgo-python-documentation/assets/js/2.6df4aee8.js"><link rel="prefetch" href="/esrgo-python-documentation/assets/css/3.styles.62e3bade.css"><link rel="prefetch" href="/esrgo-python-documentation/assets/js/3.62e3bade.js"><link rel="prefetch" href="/esrgo-python-documentation/assets/js/4.e0e8277f.js"><link rel="prefetch" href="/esrgo-python-documentation/assets/js/6.b3d7e6cd.js"><link rel="prefetch" href="/esrgo-python-documentation/assets/js/7.fcd4ff92.js"><link rel="prefetch" href="/esrgo-python-documentation/assets/js/8.3d242c4d.js"><link rel="prefetch" href="/esrgo-python-documentation/assets/js/9.234d134d.js"><link rel="prefetch" href="/esrgo-python-documentation/assets/js/10.fb3d3e85.js"><link rel="prefetch" href="/esrgo-python-documentation/assets/js/11.d1c152da.js"><link rel="prefetch" href="/esrgo-python-documentation/assets/js/12.db983685.js"><link rel="prefetch" href="/esrgo-python-documentation/assets/js/13.542e130d.js"><link rel="prefetch" href="/esrgo-python-documentation/assets/js/14.bf07540b.js"><link rel="prefetch" href="/esrgo-python-documentation/assets/js/15.123c7fb9.js"><link rel="prefetch" href="/esrgo-python-documentation/assets/js/16.8c7136bb.js"><link rel="prefetch" href="/esrgo-python-documentation/assets/js/18.19d247d1.js"><link rel="prefetch" href="/esrgo-python-documentation/assets/js/19.a9221979.js">
    <link rel="stylesheet" href="/esrgo-python-documentation/assets/css/5.styles.92ce2759.css"><link rel="stylesheet" href="/esrgo-python-documentation/assets/css/styles.08b8ebf7.css"><link rel="stylesheet" href="/esrgo-python-documentation/assets/css/1.styles.dacdc8f1.css"><link rel="stylesheet" href="/esrgo-python-documentation/assets/css/2.styles.6df4aee8.css"><link rel="stylesheet" href="/esrgo-python-documentation/assets/css/3.styles.62e3bade.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/esrgo-python-documentation/" class="home-link router-link-active"><!----> <span class="site-name">C# Interface port to Python</span></a> <div class="links" style="max-width:nullpx;"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/esrgo-python-documentation/" class="nav-link">Overview</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">Domain Model</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/esrgo-python-documentation/domain-generation.html" class="nav-link">Domain Model Code Generation</a></li><li class="dropdown-item"><!----> <a href="/esrgo-python-documentation/serializing-objects.html" class="nav-link router-link-exact-active router-link-active">Serializing Objects in Correct Order</a></li><li class="dropdown-item"><!----> <a href="/esrgo-python-documentation/initializing-model-classes.html" class="nav-link">Initializing Model Classes</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">Processing</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/esrgo-python-documentation/commands.html" class="nav-link">Commands</a></li><li class="dropdown-item"><!----> <a href="/esrgo-python-documentation/csv-processing.html" class="nav-link">CSV Processing</a></li><li class="dropdown-item"><!----> <a href="/esrgo-python-documentation/file-handling-with-regex.html" class="nav-link">File Handling with Regex</a></li><li class="dropdown-item"><!----> <a href="/esrgo-python-documentation/logging-with-xml-serialization.html" class="nav-link">Logging with XML Serialization</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">SqlAlchemy</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/esrgo-python-documentation/extracting-data-with-sqlalchemy.html" class="nav-link">Extracting Data with SqlAlchemy ORM</a></li><li class="dropdown-item"><!----> <a href="/esrgo-python-documentation/query-windowing-with-sqlalchemy.html" class="nav-link">Query Windowing with SqlAlchemy ORM</a></li><li class="dropdown-item"><!----> <a href="/esrgo-python-documentation/query-windowing-with-a-filter-criteria.html" class="nav-link">Query Windowing with a Filter Criteria</a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/esrgo-python-documentation/" class="nav-link">Overview</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">Domain Model</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/esrgo-python-documentation/domain-generation.html" class="nav-link">Domain Model Code Generation</a></li><li class="dropdown-item"><!----> <a href="/esrgo-python-documentation/serializing-objects.html" class="nav-link router-link-exact-active router-link-active">Serializing Objects in Correct Order</a></li><li class="dropdown-item"><!----> <a href="/esrgo-python-documentation/initializing-model-classes.html" class="nav-link">Initializing Model Classes</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">Processing</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/esrgo-python-documentation/commands.html" class="nav-link">Commands</a></li><li class="dropdown-item"><!----> <a href="/esrgo-python-documentation/csv-processing.html" class="nav-link">CSV Processing</a></li><li class="dropdown-item"><!----> <a href="/esrgo-python-documentation/file-handling-with-regex.html" class="nav-link">File Handling with Regex</a></li><li class="dropdown-item"><!----> <a href="/esrgo-python-documentation/logging-with-xml-serialization.html" class="nav-link">Logging with XML Serialization</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">SqlAlchemy</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/esrgo-python-documentation/extracting-data-with-sqlalchemy.html" class="nav-link">Extracting Data with SqlAlchemy ORM</a></li><li class="dropdown-item"><!----> <a href="/esrgo-python-documentation/query-windowing-with-sqlalchemy.html" class="nav-link">Query Windowing with SqlAlchemy ORM</a></li><li class="dropdown-item"><!----> <a href="/esrgo-python-documentation/query-windowing-with-a-filter-criteria.html" class="nav-link">Query Windowing with a Filter Criteria</a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><div class="sidebar-group first"><p class="sidebar-heading open"><span>Serializing Objects in Correct Order</span> <!----></p> <ul class="sidebar-group-items"><li><a href="/esrgo-python-documentation/serializing-objects.html#overview" class="sidebar-link">Overview</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/esrgo-python-documentation/serializing-objects.html#the-problem-dictionaries-iterate-in-random-order" class="sidebar-link">The Problem - Dictionaries Iterate in Random Order</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/esrgo-python-documentation/serializing-objects.html#the-solution-capturing-attribute-initialisation-order" class="sidebar-link">The Solution - Capturing Attribute Initialisation Order</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/esrgo-python-documentation/serializing-objects.html#option-1-wrapping-dict-with-an-ordereddict" class="sidebar-link">Option 1: Wrapping _dict_ with an OrderedDict</a></li><li class="sidebar-sub-header"><a href="/esrgo-python-documentation/serializing-objects.html#option-2-finding-dict-order-from-a-mock-object-instantiation" class="sidebar-link">Option 2: Finding dict order from a mock object instantiation</a></li><li class="sidebar-sub-header"><a href="/esrgo-python-documentation/serializing-objects.html#option-3-explicit-order-definition" class="sidebar-link">Option 3: Explicit order definition</a></li></ul></li><li><a href="/esrgo-python-documentation/serializing-objects.html#option-4-using-descriptors-to-help-define-attribute-ordering" class="sidebar-link">Option 4: Using Descriptors to help define attribute ordering</a><ul class="sidebar-sub-headers"></ul></li></ul></div></li></ul> </div> <div class="page"> <div class="content"><h1 id="serializing-objects-in-correct-order"><a href="#serializing-objects-in-correct-order" aria-hidden="true" class="header-anchor">#</a> Serializing Objects in Correct Order</h1> <h2 id="overview"><a href="#overview" aria-hidden="true" class="header-anchor">#</a> Overview</h2> <p>Creating a serialized representation of an object is useful in situations such as:</p> <ul><li>generating data segments for reports, UI displays, logging etc</li> <li>persisting some state to local disk, e.g. last file processed</li> <li>creating json documents for a NoSQL database</li> <li>passing objects across process boundaries</li></ul> <h2 id="the-problem-dictionaries-iterate-in-random-order"><a href="#the-problem-dictionaries-iterate-in-random-order" aria-hidden="true" class="header-anchor">#</a> The Problem - Dictionaries Iterate in Random Order</h2> <p>There are many Python libraries which assist serialization, but they all seem to suffer from the problem that the object’s dictionary returns it’s attributes in random order (that’s a fundamental of a dictionary - it does not guarantee any ordering in iterative access).</p> <p>Technically, the serialized object works with attributes in any order, but practically many of the above uses benefit from a fixed and consistent ordering - preferably the order that attributes are declared on the class.</p> <h2 id="the-solution-capturing-attribute-initialisation-order"><a href="#the-solution-capturing-attribute-initialisation-order" aria-hidden="true" class="header-anchor">#</a> The Solution - Capturing Attribute Initialisation Order</h2> <p>The basis of a solution is to capture the order in which attributes are added to an object, and apply this ordering to the dictionary when it is used for serialization.</p> <p>Python has a lot of metaclass techniques which allow solving of problems like this which involve the inner workings of objects. These are some of the techniques I investigated.</p> <h3 id="option-1-wrapping-dict-with-an-ordereddict"><a href="#option-1-wrapping-dict-with-an-ordereddict" aria-hidden="true" class="header-anchor">#</a> Option 1: Wrapping <strong>dict</strong> with an OrderedDict</h3> <p>One way is to “wrap” the <strong>dict</strong> with an OrderedDict. Overriding the setter and getter class functions makes this possible. (Here, we only need to replace the setter). The code is applied to the Model classes via a mixin class (OrderedNamespace) to the ModelBase class.</p> <p><strong>ordered_namespace.py</strong></p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">from</span> collections <span class="token keyword">import</span> OrderedDict

<span class="token comment"># Model classes inherit from OrderedNamespace</span>
<span class="token keyword">class</span> <span class="token class-name">OrderedNamespace</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span>OrderedNamespace<span class="token punctuation">,</span> self<span class="token punctuation">)</span>
              <span class="token punctuation">.</span>__setattr__<span class="token punctuation">(</span><span class="token string">'_odict'</span><span class="token punctuation">,</span> OrderedDict<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token comment"># Setter saves the attribute name in an OrderedDict</span>
    <span class="token comment"># (which preserves the order the keys are set).</span>
    <span class="token keyword">def</span> <span class="token function">__setattr__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> <span class="token builtin">hasattr</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> <span class="token string">'_odict'</span><span class="token punctuation">)</span> <span class="token operator">and</span>
           <span class="token operator">not</span> key <span class="token keyword">in</span> self<span class="token punctuation">.</span>_odict<span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>_odict<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">None</span>
        self<span class="token punctuation">.</span>__dict__<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> value

    <span class="token comment"># The property ordered_dict is used for serialization.</span>
    <span class="token comment"># Current values from the class dict are copied in.</span>
    @<span class="token builtin">property</span>
    <span class="token keyword">def</span> <span class="token function">ordered_dict</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">for</span> key <span class="token keyword">in</span> self<span class="token punctuation">.</span>_odict<span class="token punctuation">.</span>keys<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>_odict<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> self<span class="token punctuation">.</span>__dict__<span class="token punctuation">[</span>key<span class="token punctuation">]</span>
        <span class="token keyword">return</span> self<span class="token punctuation">.</span>_odict
</code></pre></div><p><strong>Problem with Option 1: Clashes with other libraries using base classes (e.g SqlAlchemy)</strong></p> <p>Unfortunately, this option interferes with SqlAlchemy, which adds instrumentation for mapping and change tracking behind the scenes. No error message is raised, but unit tests for updating records failed because the SqlAlchemy change tracking did not work with the OrderedDict enhancement.</p> <h3 id="option-2-finding-dict-order-from-a-mock-object-instantiation"><a href="#option-2-finding-dict-order-from-a-mock-object-instantiation" aria-hidden="true" class="header-anchor">#</a> Option 2: Finding dict order from a mock object instantiation</h3> <p>This method waits until serialisation time to find the required dictionary ordering. This is nice, because there is no process overhead if the class is never serialised. It does so by mocking the object’s class and overriding <strong>setattr</strong>.</p> <p><strong>Function: ordered_dict()</strong></p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">def</span> <span class="token function">ordered_dict</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> <span class="token operator">not</span> <span class="token builtin">hasattr</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> <span class="token string">'__dict__'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token boolean">None</span>

    <span class="token comment"># Attempt a mock instantiation</span>
    <span class="token comment"># If failed, just use the __dict__ as-is</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        dict_order <span class="token operator">=</span> _find_dict_order_from_mock_obj_instantiation<span class="token punctuation">(</span>obj<span class="token punctuation">)</span>
    <span class="token keyword">except</span><span class="token punctuation">:</span>
        dict_order <span class="token operator">=</span> obj<span class="token punctuation">.</span>__dict__<span class="token punctuation">.</span>keys

    <span class="token comment"># Create a list of tuples from __dict__ in the order of instantiation</span>
    _ordered_dict <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">(</span>d<span class="token punctuation">,</span> obj<span class="token punctuation">.</span>__dict__<span class="token punctuation">[</span>d<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token keyword">for</span> d <span class="token keyword">in</span> dict_order<span class="token punctuation">]</span>
    <span class="token keyword">return</span> _ordered_dict


<span class="token keyword">def</span> <span class="token function">_find_dict_order_from_mock_obj_instantiation</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">:</span>
    dict_order <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>

    <span class="token comment"># Subclass the object’s class and define a __setattr__ method</span>
    <span class="token comment"># to capture the attribute names as they are instantiated.</span>
    <span class="token keyword">class</span> <span class="token class-name">sub</span><span class="token punctuation">(</span><span class="token builtin">type</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">def</span> <span class="token function">__setattr__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">:</span>
            dict_order<span class="token punctuation">.</span>append<span class="token punctuation">(</span>key<span class="token punctuation">)</span>
            self<span class="token punctuation">.</span>__dict__<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> value

    <span class="token comment"># Inspect the __init__ method of the target class for arguments to be passed</span>
    f <span class="token operator">=</span> obj<span class="token punctuation">.</span>__class__<span class="token punctuation">.</span>__init__
    argspec <span class="token operator">=</span> inspect<span class="token punctuation">.</span>getargspec<span class="token punctuation">(</span>f<span class="token punctuation">)</span>
    args_to_pass <span class="token operator">=</span> argspec<span class="token punctuation">.</span>args<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">]</span>

    <span class="token comment"># Run a dummy initialisation of the mock object.</span>
    sub<span class="token punctuation">(</span><span class="token operator">*</span>args_to_pass<span class="token punctuation">)</span>

    <span class="token keyword">return</span> dict_order
</code></pre></div><p><strong>Problem: Class <strong>init</strong> method must only do simple attribute assignment</strong></p> <p>This works primarily because the model objects don’t do anything complicated in the <strong>init</strong> method (which is good practice). They simply instantiate fields with default values. Any use of expressions involving constructor args would likely put a spanner in the works, particularly for non-string attributes.</p> <h3 id="option-3-explicit-order-definition"><a href="#option-3-explicit-order-definition" aria-hidden="true" class="header-anchor">#</a> Option 3: Explicit order definition</h3> <p>Arguably, an explicit list of attributes for serialization is the simplest, therefore best considering Python’s maxim of “Explicit is better than implicit”</p> <p><strong>Example of explicit serialization ordering in Address model class</strong></p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">class</span> <span class="token class-name">Address</span><span class="token punctuation">(</span>ModelBase<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">&quot;&quot;&quot; Definition of the Address record type in EsrGo data files &quot;&quot;&quot;</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> <span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>
        ModelBase<span class="token punctuation">.</span>__init__<span class="token punctuation">(</span>self<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>Id <span class="token operator">=</span> <span class="token number">0</span>
        self<span class="token punctuation">.</span>EffectiveDate <span class="token operator">=</span> bot
        self<span class="token punctuation">.</span>EffectiveEndDate <span class="token operator">=</span> eot
        … <span class="token operator">&lt;&lt;</span> More attributes initialized here <span class="token operator">&gt;&gt;</span>

    @<span class="token builtin">property</span>
    <span class="token keyword">def</span> <span class="token function">sorted_for_json</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token punctuation">[</span><span class="token string">'Id'</span><span class="token punctuation">,</span> <span class="token string">'EffectiveDate'</span><span class="token punctuation">,</span> <span class="token string">'EffectiveEndDate'</span><span class="token punctuation">,</span> <span class="token string">'PersonId'</span><span class="token punctuation">,</span>
                <span class="token string">'AddressType'</span><span class="token punctuation">,</span> <span class="token string">'AddressStyle'</span><span class="token punctuation">,</span> <span class="token string">'PrimaryFlag'</span><span class="token punctuation">,</span> <span class="token string">'AddressFirstLine'</span><span class="token punctuation">,</span>
                <span class="token string">'AddressSecondLine'</span><span class="token punctuation">,</span> <span class="token string">'AddressThirdLine'</span><span class="token punctuation">,</span> <span class="token string">'AddressTown'</span><span class="token punctuation">,</span>
                <span class="token string">'AddressCounty'</span><span class="token punctuation">,</span> <span class="token string">'AddressPostcode'</span><span class="token punctuation">,</span> <span class="token string">'AddressCountry'</span><span class="token punctuation">,</span>
                <span class="token string">'LastUpdateDate'</span><span class="token punctuation">,</span> <span class="token string">'StateValue'</span><span class="token punctuation">,</span> <span class="token string">'TransportLineNo'</span><span class="token punctuation">]</span>
</code></pre></div><p>The sorted_for_json property is used in the ModelBase class as follows:</p> <p><strong>ordered_dict property of <code>ModelBase.py</code></strong></p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">class</span> <span class="token class-name">ModelBase</span><span class="token punctuation">(</span>AttrDisplay<span class="token punctuation">,</span> metaclass<span class="token operator">=</span>ABCMeta<span class="token punctuation">)</span><span class="token punctuation">:</span>
    @<span class="token builtin">property</span>
    <span class="token keyword">def</span> <span class="token function">ordered_dict</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">from</span> collections <span class="token keyword">import</span> OrderedDict
        d <span class="token operator">=</span> OrderedDict<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">for</span> a <span class="token keyword">in</span> self<span class="token punctuation">.</span>sorted_for_json<span class="token punctuation">:</span>
            <span class="token keyword">try</span><span class="token punctuation">:</span>
                d<span class="token punctuation">[</span>a<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token builtin">getattr</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> a<span class="token punctuation">)</span>
            <span class="token keyword">except</span><span class="token punctuation">:</span>
                <span class="token keyword">pass</span>
        <span class="token keyword">return</span> d
</code></pre></div><p><strong>Problem with Option 3: Changes to attributes need to be handled in two places</strong></p> <p>The downside is that this is not very DRY - when attributes are changed, this list needs to be updated as well. It would be easy to overlook the serialize list when changing the class. A regression test can guard against this:</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">class</span> <span class="token class-name">TestModelSortedForJson</span><span class="token punctuation">(</span>unittest<span class="token punctuation">.</span>TestCase<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">object_sorted_json_list_contains_all_attributes</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> obj<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> <span class="token operator">not</span> <span class="token builtin">callable</span><span class="token punctuation">(</span><span class="token builtin">getattr</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> <span class="token string">'sorted_for_json'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">raise</span> NotImplementedError<span class="token punctuation">(</span><span class="token string">&quot;sorted_for_json&quot;</span><span class="token punctuation">)</span>
        attributes <span class="token operator">=</span> <span class="token builtin">sorted</span><span class="token punctuation">(</span>obj<span class="token punctuation">.</span>__dict__<span class="token punctuation">.</span>keys<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        json_sorted <span class="token operator">=</span> <span class="token builtin">sorted</span><span class="token punctuation">(</span>obj<span class="token punctuation">.</span>sorted_for_json<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> attributes <span class="token operator">==</span> json_sorted

    <span class="token keyword">def</span> <span class="token function">test01_address_json_sortorder_contains_all_attributes</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        address <span class="token operator">=</span> Address<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>assertTrue<span class="token punctuation">(</span>
            self<span class="token punctuation">.</span>object_sorted_json_list_contains_all_attributes<span class="token punctuation">(</span>address<span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><h2 id="option-4-using-descriptors-to-help-define-attribute-ordering"><a href="#option-4-using-descriptors-to-help-define-attribute-ordering" aria-hidden="true" class="header-anchor">#</a> Option 4: Using Descriptors to help define attribute ordering</h2> <p>Descriptors are a meta-programming objects which allow standard class behaviour to be altered.</p> <p>To use them in the context of recording attribute ordering, we define attributes at the class level using descriptors, rather than the usual way of assigning properties of self in the <strong>init</strong> method.</p> <p>In some ways, this looks closer to the C# way of defining properties.</p> <p>A Metaclass is then used during class creation to capture the list of attributes and their order by looking for descriptors of type ModelDescriptorBase.</p> <p>Note, descriptors could be used for other purposes so a specific abstract base class is used for these descriptors.</p> <p>Defining the model class:</p> <p><strong>Use of descriptors to define model class attributes</strong></p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">class</span> <span class="token class-name">Address</span><span class="token punctuation">(</span>ModelBase<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># The metaclass will record the name and order of these class  attributes.</span>
    Id <span class="token operator">=</span> IntDescriptor<span class="token punctuation">(</span><span class="token punctuation">)</span>
    EffectiveDate <span class="token operator">=</span> DateDescriptor<span class="token punctuation">(</span><span class="token punctuation">)</span>
    EffectiveEndDate <span class="token operator">=</span> EndDateDescriptor<span class="token punctuation">(</span><span class="token punctuation">)</span>
    PersonId <span class="token operator">=</span> IntDescriptor<span class="token punctuation">(</span><span class="token punctuation">)</span>
    AddressFirstLine <span class="token operator">=</span> StringDescriptor<span class="token punctuation">(</span><span class="token punctuation">)</span>
    AddressSecondLine <span class="token operator">=</span> StringDescriptor<span class="token punctuation">(</span><span class="token punctuation">)</span>
    AddressThirdLine <span class="token operator">=</span> StringDescriptor<span class="token punctuation">(</span><span class="token punctuation">)</span>
    AddressTown <span class="token operator">=</span> StringDescriptor<span class="token punctuation">(</span><span class="token punctuation">)</span>
    AddressCounty <span class="token operator">=</span> StringDescriptor<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> <span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>
        ModelBase<span class="token punctuation">.</span>__init__<span class="token punctuation">(</span>self<span class="token punctuation">)</span>
        <span class="token comment"># Instantiate instance attributes here with default values</span>
        <span class="token keyword">for</span> d <span class="token keyword">in</span> self<span class="token punctuation">.</span>_descriptors<span class="token punctuation">:</span>
            <span class="token builtin">setattr</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> d<span class="token punctuation">.</span>attribute_name<span class="token punctuation">,</span> d<span class="token punctuation">.</span>default<span class="token punctuation">)</span>
</code></pre></div><p>Recording the attribute ordering:</p> <p><strong>Metaclass to process the model class descriptors</strong></p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">class</span> <span class="token class-name">ModelMetaclass</span><span class="token punctuation">(</span><span class="token builtin">type</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__new__</span><span class="token punctuation">(</span>cls<span class="token punctuation">,</span> name<span class="token punctuation">,</span> bases<span class="token punctuation">,</span> attrs<span class="token punctuation">)</span><span class="token punctuation">:</span>
        descriptors <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        order <span class="token operator">=</span> <span class="token number">0</span>
        <span class="token comment"># The metaclass scans the class attributes for descriptors</span>
        <span class="token keyword">for</span> n<span class="token punctuation">,</span> v <span class="token keyword">in</span> attrs<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">if</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>v<span class="token punctuation">,</span> ModelDescriptorBase<span class="token punctuation">)</span><span class="token punctuation">:</span>
                v<span class="token punctuation">.</span>attribute_name <span class="token operator">=</span> n
                v<span class="token punctuation">.</span>instantiation_order <span class="token operator">=</span> order
                order <span class="token operator">+=</span> <span class="token number">1</span>
                descriptors<span class="token punctuation">.</span>append<span class="token punctuation">(</span>v<span class="token punctuation">)</span>
        <span class="token comment"># Remove the descriptors as they interfere with SqlAlchemy Instrumentation</span>
        <span class="token keyword">for</span> d <span class="token keyword">in</span> descriptors<span class="token punctuation">:</span>
            attrs<span class="token punctuation">.</span>pop<span class="token punctuation">(</span>d<span class="token punctuation">.</span>attribute_name<span class="token punctuation">)</span>
        <span class="token comment"># Create the class instance and add the descriptors as a list</span>
        cls_instance <span class="token operator">=</span> <span class="token builtin">super</span><span class="token punctuation">(</span>ModelMetaclass<span class="token punctuation">,</span> cls<span class="token punctuation">)</span>
                       <span class="token punctuation">.</span>__new__<span class="token punctuation">(</span>cls<span class="token punctuation">,</span> name<span class="token punctuation">,</span> bases<span class="token punctuation">,</span> attrs<span class="token punctuation">)</span>
        cls_instance<span class="token punctuation">.</span>_descriptors <span class="token operator">=</span> descriptors
        <span class="token keyword">return</span> cls_instance
</code></pre></div><p>Definition of Model descriptors:</p> <p><strong>Model descriptors and base class</strong></p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">from</span> abc <span class="token keyword">import</span> ABCMeta
<span class="token keyword">from</span> decimal <span class="token keyword">import</span> Decimal
<span class="token keyword">from</span> Utility<span class="token punctuation">.</span>date_constants <span class="token keyword">import</span> bot<span class="token punctuation">,</span> eot<span class="token punctuation">,</span> bot_datetime

<span class="token keyword">class</span> <span class="token class-name">ModelDescriptorBase</span><span class="token punctuation">(</span>metaclass<span class="token operator">=</span>ABCMeta<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>attribute_name <span class="token operator">=</span> <span class="token boolean">None</span>
        self<span class="token punctuation">.</span>default <span class="token operator">=</span> default
        self<span class="token punctuation">.</span>instantiation_order <span class="token operator">=</span> <span class="token number">0</span>

    <span class="token keyword">def</span> <span class="token function">__get__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> instance<span class="token punctuation">,</span> owner<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">pass</span>

    <span class="token keyword">def</span> <span class="token function">__set__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> instance<span class="token punctuation">,</span> val<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">pass</span>

    <span class="token keyword">def</span> <span class="token function">__repr__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token string">&quot;{}, order: {}, default: {}, descriptor: {}&quot;</span>\
            <span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>attribute_name<span class="token punctuation">,</span> self<span class="token punctuation">.</span>instantiation_order<span class="token punctuation">,</span> self<span class="token punctuation">.</span>default<span class="token punctuation">,</span>
                    <span class="token builtin">type</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">.</span>__name__<span class="token punctuation">)</span>

<span class="token keyword">class</span> <span class="token class-name">DecimalDescriptor</span><span class="token punctuation">(</span>ModelDescriptorBase<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span>default<span class="token operator">=</span>Decimal<span class="token punctuation">(</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">class</span> <span class="token class-name">IntDescriptor</span><span class="token punctuation">(</span>ModelDescriptorBase<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span>default<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>

<span class="token keyword">class</span> <span class="token class-name">StringDescriptor</span><span class="token punctuation">(</span>ModelDescriptorBase<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span>default<span class="token operator">=</span><span class="token string">''</span><span class="token punctuation">)</span>

<span class="token keyword">class</span> <span class="token class-name">BoolDescriptor</span><span class="token punctuation">(</span>ModelDescriptorBase<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span>default<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>

<span class="token keyword">class</span> <span class="token class-name">DateDescriptor</span><span class="token punctuation">(</span>ModelDescriptorBase<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span>default<span class="token operator">=</span>bot<span class="token punctuation">)</span>

<span class="token keyword">class</span> <span class="token class-name">EndDateDescriptor</span><span class="token punctuation">(</span>ModelDescriptorBase<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span>default<span class="token operator">=</span>eot<span class="token punctuation">)</span>

<span class="token keyword">class</span> <span class="token class-name">DateTimeDescriptor</span><span class="token punctuation">(</span>ModelDescriptorBase<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span>default<span class="token operator">=</span>bot_datetime<span class="token punctuation">)</span>
</code></pre></div><div class="minimap-container" style="width:250px;" data-v-5674b532><div class="minimap" style="top:250px;zoom:25%;" data-v-5674b532><div data-v-5674b532></div></div></div></div> <div class="page-edit"><!----> <!----></div> <!----> </div> <!----></div></div>
    <script src="/esrgo-python-documentation/assets/js/17.4bf3763a.js" defer></script><script src="/esrgo-python-documentation/assets/js/5.92ce2759.js" defer></script><script src="/esrgo-python-documentation/assets/js/app.08b8ebf7.js" defer></script>
  </body>
</html>
