<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Extracting Data with SqlAlchemy ORM | C# Interface port to Python</title>
    <meta name="description" content="C# Interface port to Python">
    
    
    <link rel="preload" href="/esrgo-python-documentation/assets/css/styles.08b8ebf7.css" as="style"><link rel="preload" href="/esrgo-python-documentation/assets/js/app.08b8ebf7.js" as="script"><link rel="preload" href="/esrgo-python-documentation/assets/js/11.d1c152da.js" as="script"><link rel="preload" href="/esrgo-python-documentation/assets/css/5.styles.92ce2759.css" as="style"><link rel="preload" href="/esrgo-python-documentation/assets/js/5.92ce2759.js" as="script"><link rel="prefetch" href="/esrgo-python-documentation/assets/css/1.styles.dacdc8f1.css"><link rel="prefetch" href="/esrgo-python-documentation/assets/js/1.dacdc8f1.js"><link rel="prefetch" href="/esrgo-python-documentation/assets/css/2.styles.6df4aee8.css"><link rel="prefetch" href="/esrgo-python-documentation/assets/js/2.6df4aee8.js"><link rel="prefetch" href="/esrgo-python-documentation/assets/css/3.styles.62e3bade.css"><link rel="prefetch" href="/esrgo-python-documentation/assets/js/3.62e3bade.js"><link rel="prefetch" href="/esrgo-python-documentation/assets/js/4.e0e8277f.js"><link rel="prefetch" href="/esrgo-python-documentation/assets/js/6.b3d7e6cd.js"><link rel="prefetch" href="/esrgo-python-documentation/assets/js/7.fcd4ff92.js"><link rel="prefetch" href="/esrgo-python-documentation/assets/js/8.3d242c4d.js"><link rel="prefetch" href="/esrgo-python-documentation/assets/js/9.234d134d.js"><link rel="prefetch" href="/esrgo-python-documentation/assets/js/10.fb3d3e85.js"><link rel="prefetch" href="/esrgo-python-documentation/assets/js/12.db983685.js"><link rel="prefetch" href="/esrgo-python-documentation/assets/js/13.542e130d.js"><link rel="prefetch" href="/esrgo-python-documentation/assets/js/14.bf07540b.js"><link rel="prefetch" href="/esrgo-python-documentation/assets/js/15.123c7fb9.js"><link rel="prefetch" href="/esrgo-python-documentation/assets/js/16.8c7136bb.js"><link rel="prefetch" href="/esrgo-python-documentation/assets/js/17.4bf3763a.js"><link rel="prefetch" href="/esrgo-python-documentation/assets/js/18.19d247d1.js"><link rel="prefetch" href="/esrgo-python-documentation/assets/js/19.a9221979.js">
    <link rel="stylesheet" href="/esrgo-python-documentation/assets/css/5.styles.92ce2759.css"><link rel="stylesheet" href="/esrgo-python-documentation/assets/css/styles.08b8ebf7.css"><link rel="stylesheet" href="/esrgo-python-documentation/assets/css/1.styles.dacdc8f1.css"><link rel="stylesheet" href="/esrgo-python-documentation/assets/css/2.styles.6df4aee8.css"><link rel="stylesheet" href="/esrgo-python-documentation/assets/css/3.styles.62e3bade.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/esrgo-python-documentation/" class="home-link router-link-active"><!----> <span class="site-name">C# Interface port to Python</span></a> <div class="links" style="max-width:nullpx;"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/esrgo-python-documentation/" class="nav-link">Overview</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">Domain Model</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/esrgo-python-documentation/domain-generation.html" class="nav-link">Domain Model Code Generation</a></li><li class="dropdown-item"><!----> <a href="/esrgo-python-documentation/serializing-objects.html" class="nav-link">Serializing Objects in Correct Order</a></li><li class="dropdown-item"><!----> <a href="/esrgo-python-documentation/initializing-model-classes.html" class="nav-link">Initializing Model Classes</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">Processing</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/esrgo-python-documentation/commands.html" class="nav-link">Commands</a></li><li class="dropdown-item"><!----> <a href="/esrgo-python-documentation/csv-processing.html" class="nav-link">CSV Processing</a></li><li class="dropdown-item"><!----> <a href="/esrgo-python-documentation/file-handling-with-regex.html" class="nav-link">File Handling with Regex</a></li><li class="dropdown-item"><!----> <a href="/esrgo-python-documentation/logging-with-xml-serialization.html" class="nav-link">Logging with XML Serialization</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">SqlAlchemy</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/esrgo-python-documentation/extracting-data-with-sqlalchemy.html" class="nav-link router-link-exact-active router-link-active">Extracting Data with SqlAlchemy ORM</a></li><li class="dropdown-item"><!----> <a href="/esrgo-python-documentation/query-windowing-with-sqlalchemy.html" class="nav-link">Query Windowing with SqlAlchemy ORM</a></li><li class="dropdown-item"><!----> <a href="/esrgo-python-documentation/query-windowing-with-a-filter-criteria.html" class="nav-link">Query Windowing with a Filter Criteria</a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/esrgo-python-documentation/" class="nav-link">Overview</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">Domain Model</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/esrgo-python-documentation/domain-generation.html" class="nav-link">Domain Model Code Generation</a></li><li class="dropdown-item"><!----> <a href="/esrgo-python-documentation/serializing-objects.html" class="nav-link">Serializing Objects in Correct Order</a></li><li class="dropdown-item"><!----> <a href="/esrgo-python-documentation/initializing-model-classes.html" class="nav-link">Initializing Model Classes</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">Processing</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/esrgo-python-documentation/commands.html" class="nav-link">Commands</a></li><li class="dropdown-item"><!----> <a href="/esrgo-python-documentation/csv-processing.html" class="nav-link">CSV Processing</a></li><li class="dropdown-item"><!----> <a href="/esrgo-python-documentation/file-handling-with-regex.html" class="nav-link">File Handling with Regex</a></li><li class="dropdown-item"><!----> <a href="/esrgo-python-documentation/logging-with-xml-serialization.html" class="nav-link">Logging with XML Serialization</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">SqlAlchemy</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/esrgo-python-documentation/extracting-data-with-sqlalchemy.html" class="nav-link router-link-exact-active router-link-active">Extracting Data with SqlAlchemy ORM</a></li><li class="dropdown-item"><!----> <a href="/esrgo-python-documentation/query-windowing-with-sqlalchemy.html" class="nav-link">Query Windowing with SqlAlchemy ORM</a></li><li class="dropdown-item"><!----> <a href="/esrgo-python-documentation/query-windowing-with-a-filter-criteria.html" class="nav-link">Query Windowing with a Filter Criteria</a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><div class="sidebar-group first"><p class="sidebar-heading open"><span>Extracting Data with SqlAlchemy ORM</span> <!----></p> <ul class="sidebar-group-items"><li><a href="/esrgo-python-documentation/extracting-data-with-sqlalchemy.html#sqlalchemy-query" class="sidebar-link">SqlAlchemy Query</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/esrgo-python-documentation/extracting-data-with-sqlalchemy.html#prerequisites-table-mappings" class="sidebar-link">Prerequisites - Table Mappings</a></li><li class="sidebar-sub-header"><a href="/esrgo-python-documentation/extracting-data-with-sqlalchemy.html#query" class="sidebar-link">Query()</a></li><li class="sidebar-sub-header"><a href="/esrgo-python-documentation/extracting-data-with-sqlalchemy.html#column-selection" class="sidebar-link">Column Selection</a></li><li class="sidebar-sub-header"><a href="/esrgo-python-documentation/extracting-data-with-sqlalchemy.html#joining-tables-mapper-defined-relationship" class="sidebar-link">Joining tables - Mapper defined relationship</a></li><li class="sidebar-sub-header"><a href="/esrgo-python-documentation/extracting-data-with-sqlalchemy.html#joining-tables-explicit-join-criteria" class="sidebar-link">Joining Tables - Explicit join criteria</a></li><li class="sidebar-sub-header"><a href="/esrgo-python-documentation/extracting-data-with-sqlalchemy.html#self-join-tables" class="sidebar-link">Self-Join Tables</a></li></ul></li><li><a href="/esrgo-python-documentation/extracting-data-with-sqlalchemy.html#example-1-snapshot-data-stream" class="sidebar-link">Example 1 - Snapshot Data Stream</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/esrgo-python-documentation/extracting-data-with-sqlalchemy.html#record-selection" class="sidebar-link">Record Selection</a></li><li class="sidebar-sub-header"><a href="/esrgo-python-documentation/extracting-data-with-sqlalchemy.html#joins" class="sidebar-link">Joins</a></li><li class="sidebar-sub-header"><a href="/esrgo-python-documentation/extracting-data-with-sqlalchemy.html#extract-columns" class="sidebar-link">Extract Columns</a></li><li class="sidebar-sub-header"><a href="/esrgo-python-documentation/extracting-data-with-sqlalchemy.html#setting-processed-status" class="sidebar-link">Setting Processed Status</a></li></ul></li><li><a href="/esrgo-python-documentation/extracting-data-with-sqlalchemy.html#example-2-assignment-changes" class="sidebar-link">Example 2 - Assignment Changes</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/esrgo-python-documentation/extracting-data-with-sqlalchemy.html#record-selection-2" class="sidebar-link">Record Selection</a></li></ul></li></ul></div></li></ul> </div> <div class="page"> <div class="content"><h1 id="extracting-data-with-sqlalchemy-orm"><a href="#extracting-data-with-sqlalchemy-orm" aria-hidden="true" class="header-anchor">#</a> Extracting Data with SqlAlchemy ORM</h1> <h2 id="sqlalchemy-query"><a href="#sqlalchemy-query" aria-hidden="true" class="header-anchor">#</a> SqlAlchemy Query</h2> <p>SqlAlchemy ORM is the Python equivalent of .Net’s Entity Framework. It can be used to compose SQL queries against the database and return result sets. This document describes the Python syntax used to implement a couple of the extraction use-cases of the interface project.</p> <h3 id="prerequisites-table-mappings"><a href="#prerequisites-table-mappings" aria-hidden="true" class="header-anchor">#</a> Prerequisites - Table Mappings</h3> <p>The basic requirement is an ORM Session with mapper defining relationships between Model classes and tables. A Repository encapsulates the table mappings for loading the data, so this can be re-used for the extractions.</p> <p><strong>SqlAlchemy Repository with table mappings</strong></p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">from</span> sqlalchemy <span class="token keyword">import</span> create_engine<span class="token punctuation">,</span> MetaData
<span class="token keyword">from</span> sqlalchemy<span class="token punctuation">.</span>orm <span class="token keyword">import</span> Session<span class="token punctuation">,</span> scoped_session<span class="token punctuation">,</span> sessionmaker<span class="token punctuation">,</span> clear_mappers<span class="token punctuation">,</span> mapper
<span class="token keyword">from</span> sqlalchemy<span class="token punctuation">.</span>orm<span class="token punctuation">.</span>exc <span class="token keyword">import</span> NoResultFound
<span class="token keyword">from</span> Database<span class="token punctuation">.</span>Table_Definitions <span class="token keyword">import</span> <span class="token operator">*</span>
<span class="token keyword">from</span> Model <span class="token keyword">import</span> <span class="token operator">*</span>
<span class="token keyword">from</span> Database<span class="token punctuation">.</span>abstract_repository <span class="token keyword">import</span> AbstractRepository

<span class="token keyword">class</span> <span class="token class-name">GenericSqlRepository</span><span class="token punctuation">(</span>AbstractRepository<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> uri<span class="token punctuation">,</span> echo<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> bulk_load_buffer<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>uri <span class="token operator">=</span> uri
        self<span class="token punctuation">.</span>engine <span class="token operator">=</span> create_engine<span class="token punctuation">(</span>uri<span class="token punctuation">,</span> echo<span class="token operator">=</span>echo<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>metadata <span class="token operator">=</span> MetaData<span class="token punctuation">(</span>self<span class="token punctuation">.</span>engine<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>session <span class="token operator">=</span> scoped_session<span class="token punctuation">(</span>sessionmaker<span class="token punctuation">(</span>bind<span class="token operator">=</span>self<span class="token punctuation">.</span>engine<span class="token punctuation">)</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>session<span class="token punctuation">.</span>autoflush <span class="token operator">=</span> <span class="token boolean">False</span>
        self<span class="token punctuation">.</span>create_all_tables<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>_map_tables<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">create_all_tables</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>absence_training_table <span class="token operator">=</span> table_factory_absence_training
                                         <span class="token punctuation">.</span>make_absence_training_table<span class="token punctuation">(</span>self<span class="token punctuation">.</span>metadata<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>address_table <span class="token operator">=</span> table_factory_address<span class="token punctuation">.</span>make_address_table<span class="token punctuation">(</span>self<span class="token punctuation">.</span>metadata<span class="token punctuation">)</span>
        … more tables

    <span class="token keyword">def</span> <span class="token function">_map_tables</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        clear_mappers<span class="token punctuation">(</span><span class="token punctuation">)</span>
        mapper<span class="token punctuation">(</span>absence_training<span class="token punctuation">.</span>AbsenceTraining<span class="token punctuation">,</span> self<span class="token punctuation">.</span>absence_training_table<span class="token punctuation">)</span>
        mapper<span class="token punctuation">(</span>address<span class="token punctuation">.</span>Address<span class="token punctuation">,</span> self<span class="token punctuation">.</span>address_table<span class="token punctuation">)</span>
        … more tables
</code></pre></div><p><strong>table  factory for addresses</strong></p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">from</span> sqlalchemy <span class="token keyword">import</span> Table<span class="token punctuation">,</span> Column<span class="token punctuation">,</span> Integer<span class="token punctuation">,</span> DateTime<span class="token punctuation">,</span> Unicode<span class="token punctuation">,</span> Numeric

<span class="token keyword">def</span> <span class="token function">make_address_table</span><span class="token punctuation">(</span>metadata<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> Table<span class="token punctuation">(</span><span class="token string">'address'</span><span class="token punctuation">,</span> metadata<span class="token punctuation">,</span>
                 Column<span class="token punctuation">(</span><span class="token string">'Id'</span><span class="token punctuation">,</span> Integer<span class="token punctuation">,</span> primary_key<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                 Column<span class="token punctuation">(</span><span class="token string">'EffectiveDate'</span><span class="token punctuation">,</span> DateTime<span class="token punctuation">,</span> primary_key<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                 Column<span class="token punctuation">(</span><span class="token string">'EffectiveEndDate'</span><span class="token punctuation">,</span> DateTime<span class="token punctuation">)</span><span class="token punctuation">,</span>
                 Column<span class="token punctuation">(</span><span class="token string">'PersonId'</span><span class="token punctuation">,</span> Integer<span class="token punctuation">)</span><span class="token punctuation">,</span>
                 Column<span class="token punctuation">(</span><span class="token string">'AddressType'</span><span class="token punctuation">,</span> Unicode<span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                 Column<span class="token punctuation">(</span><span class="token string">'AddressStyle'</span><span class="token punctuation">,</span> Unicode<span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                 Column<span class="token punctuation">(</span><span class="token string">'PrimaryFlag'</span><span class="token punctuation">,</span> Integer<span class="token punctuation">)</span><span class="token punctuation">,</span>
                 Column<span class="token punctuation">(</span><span class="token string">'AddressFirstLine'</span><span class="token punctuation">,</span> Unicode<span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                 Column<span class="token punctuation">(</span><span class="token string">'AddressSecondLine'</span><span class="token punctuation">,</span> Unicode<span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                 Column<span class="token punctuation">(</span><span class="token string">'AddressThirdLine'</span><span class="token punctuation">,</span> Unicode<span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                 Column<span class="token punctuation">(</span><span class="token string">'AddressTown'</span><span class="token punctuation">,</span> Unicode<span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                 Column<span class="token punctuation">(</span><span class="token string">'AddressCounty'</span><span class="token punctuation">,</span> Unicode<span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                 Column<span class="token punctuation">(</span><span class="token string">'AddressPostcode'</span><span class="token punctuation">,</span> Unicode<span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                 Column<span class="token punctuation">(</span><span class="token string">'AddressCountry'</span><span class="token punctuation">,</span> Unicode<span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                 Column<span class="token punctuation">(</span><span class="token string">'LastUpdateDate'</span><span class="token punctuation">,</span> DateTime<span class="token punctuation">)</span><span class="token punctuation">,</span>
                 Column<span class="token punctuation">(</span><span class="token string">'StateValue'</span><span class="token punctuation">,</span> Integer<span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                 Column<span class="token punctuation">(</span><span class="token string">'TransportLineNo'</span><span class="token punctuation">,</span> Integer<span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="query"><a href="#query" aria-hidden="true" class="header-anchor">#</a> Query()</h3> <p>The query() method of the Session object kicks off the definition of the query. It can take a class as a parameter, which tells the ORM what table to base the SELECT on.</p> <p>In this example, the Assignment class is specified, which the mapper will translate into the assignment table. By specifying the class only, all columns will be returned.</p> <p><strong>python</strong></p> <div class="language-python extra-class"><pre class="language-python"><code>query <span class="token operator">=</span> session<span class="token punctuation">.</span>query<span class="token punctuation">(</span>Assignment<span class="token punctuation">)</span>
</code></pre></div><p><strong>sql</strong></p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> assignments
</code></pre></div><h3 id="column-selection"><a href="#column-selection" aria-hidden="true" class="header-anchor">#</a> Column Selection</h3> <p>To restrict the columns returned, we can specify a list of the class attributes as arguments to Query().</p> <p><strong>python</strong></p> <div class="language-python extra-class"><pre class="language-python"><code>query <span class="token operator">=</span> session<span class="token punctuation">.</span>query<span class="token punctuation">(</span>Assignment<span class="token punctuation">.</span>AssignmentNumber<span class="token punctuation">,</span> Assignment<span class="token punctuation">.</span>Grade<span class="token punctuation">)</span>
</code></pre></div><p><strong>sql</strong></p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">SELECT</span> AssignmentNumber<span class="token punctuation">,</span> Grade <span class="token keyword">FROM</span> assignments
</code></pre></div><h3 id="joining-tables-mapper-defined-relationship"><a href="#joining-tables-mapper-defined-relationship" aria-hidden="true" class="header-anchor">#</a> Joining tables - Mapper defined relationship</h3> <p>If the ORM already has table relationships defined, it is sufficient to specify the tables in the query() method.</p> <p><strong>python</strong></p> <div class="language-python extra-class"><pre class="language-python"><code>query <span class="token operator">=</span> session<span class="token punctuation">.</span>query<span class="token punctuation">(</span>PersonDetail<span class="token punctuation">.</span>Name<span class="token punctuation">,</span> Assignment<span class="token punctuation">.</span>AssignmentNumber<span class="token punctuation">)</span>
</code></pre></div><p><strong>sql</strong></p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">SELECT</span>  pd<span class="token punctuation">.</span>Name<span class="token punctuation">,</span> a<span class="token punctuation">.</span>AssignmentNumber
<span class="token keyword">FROM</span>    person_detail pd<span class="token punctuation">,</span> assignment a
<span class="token keyword">WHERE</span>   pd<span class="token punctuation">.</span>Id <span class="token operator">=</span> a<span class="token punctuation">.</span>PersonId
</code></pre></div><h3 id="joining-tables-explicit-join-criteria"><a href="#joining-tables-explicit-join-criteria" aria-hidden="true" class="header-anchor">#</a> Joining Tables - Explicit join criteria</h3> <p>In this project the tables aren’t joined by foreign keys, because the use of EffectiveDate makes it difficult to precisely define the relationship.</p> <p>Instead, we define the join criteria in the extract query, with the effective date parameterizing the SQL.</p> <p>Note, when we specify columns in the query() method, the first table referenced (PersonDetail) is the “primary” table and the join() method references the “secondary” table (Assignment).</p> <p><strong>python</strong></p> <div class="language-python extra-class"><pre class="language-python"><code>query <span class="token operator">=</span> session<span class="token punctuation">.</span>query<span class="token punctuation">(</span>PersonDetail<span class="token punctuation">.</span>Name<span class="token punctuation">,</span> Assignment<span class="token punctuation">.</span>AssignmentNumber<span class="token punctuation">)</span> \
               <span class="token punctuation">.</span>join<span class="token punctuation">(</span>Assignment<span class="token punctuation">,</span> Assignment<span class="token punctuation">.</span>PersonId <span class="token operator">==</span> PersonDetail<span class="token punctuation">.</span>Id<span class="token punctuation">)</span> \
               <span class="token punctuation">.</span><span class="token builtin">filter</span><span class="token punctuation">(</span>Assignment<span class="token punctuation">.</span>EffectiveDate <span class="token operator">&lt;=</span> self<span class="token punctuation">.</span>effective_date<span class="token punctuation">)</span> \
               <span class="token punctuation">.</span><span class="token builtin">filter</span><span class="token punctuation">(</span>Assignment<span class="token punctuation">.</span>EffectiveEndDate <span class="token operator">&gt;=</span> self<span class="token punctuation">.</span>effective_date<span class="token punctuation">)</span> \
               <span class="token punctuation">.</span><span class="token builtin">filter</span><span class="token punctuation">(</span>PersonDetail<span class="token punctuation">.</span>EffectiveDate <span class="token operator">&lt;=</span> self<span class="token punctuation">.</span>effective_date<span class="token punctuation">)</span> \
               <span class="token punctuation">.</span><span class="token builtin">filter</span><span class="token punctuation">(</span>PersonDetail<span class="token punctuation">.</span>EffectiveEndDate <span class="token operator">&gt;=</span> self<span class="token punctuation">.</span>effective_date<span class="token punctuation">)</span>
</code></pre></div><p><strong>sql</strong></p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">SELECT</span>   pd<span class="token punctuation">.</span>Name<span class="token punctuation">,</span> a<span class="token punctuation">.</span>AssignmentNumber 
<span class="token keyword">FROM</span>     person_detail pd<span class="token punctuation">,</span> assignment a
<span class="token keyword">WHERE</span>    pd<span class="token punctuation">.</span>Id <span class="token operator">=</span> a<span class="token punctuation">.</span>PersonId
<span class="token operator">AND</span>      a<span class="token punctuation">.</span>EffectiveDate <span class="token operator">&lt;=</span> ?
<span class="token operator">AND</span>      a<span class="token punctuation">.</span>EffectiveEndDate <span class="token operator">&gt;=</span> ?
<span class="token operator">AND</span>      pd<span class="token punctuation">.</span>EffectiveDate <span class="token operator">&lt;=</span> ?
<span class="token operator">AND</span>      pd<span class="token punctuation">.</span>EffectiveEndDate <span class="token operator">&gt;=</span> ?
</code></pre></div><h3 id="self-join-tables"><a href="#self-join-tables" aria-hidden="true" class="header-anchor">#</a> Self-Join Tables</h3> <p>For queries that require a table to be joined to itself, we can create an alias and join the table to the alias as if they were two tables, or join the table to a subquery.</p> <p>This example extracts a full set of a person’s Assignments where any of the set has StateValue == 0.</p> <p><strong>python</strong></p> <div class="language-python extra-class"><pre class="language-python"><code>sub_query <span class="token operator">=</span> session<span class="token punctuation">.</span>query<span class="token punctuation">(</span>Assignment<span class="token punctuation">.</span>PersonId<span class="token punctuation">)</span> \
    <span class="token punctuation">.</span><span class="token builtin">filter</span><span class="token punctuation">(</span>Assignment<span class="token punctuation">.</span>StateValue <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> \
    <span class="token punctuation">.</span>distinct<span class="token punctuation">(</span><span class="token punctuation">)</span> \
    <span class="token punctuation">.</span>subquery<span class="token punctuation">(</span><span class="token punctuation">)</span>

query <span class="token operator">=</span> session<span class="token punctuation">.</span>query<span class="token punctuation">(</span>Assignment<span class="token punctuation">.</span>PersonId<span class="token punctuation">,</span> Assignment<span class="token punctuation">.</span>AssignmentNumber<span class="token punctuation">)</span> \
    <span class="token punctuation">.</span>join<span class="token punctuation">(</span>sub_query<span class="token punctuation">,</span> Assignment<span class="token punctuation">.</span>PersonId <span class="token operator">==</span> sub_query<span class="token punctuation">.</span>c<span class="token punctuation">.</span>PersonId<span class="token punctuation">)</span>
</code></pre></div><p><strong>sql</strong></p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">SELECT</span> assignment<span class="token punctuation">.</span>PersonId<span class="token punctuation">,</span> assignment<span class="token punctuation">.</span>AssignmentNumber
<span class="token keyword">FROM</span> assignment
<span class="token keyword">JOIN</span> <span class="token punctuation">(</span><span class="token keyword">SELECT</span> <span class="token keyword">DISTINCT</span> assignment<span class="token punctuation">.</span>PersonId
      <span class="token keyword">FROM</span> assignment
      <span class="token keyword">WHERE</span> assignment<span class="token punctuation">.</span>StateValue <span class="token operator">=</span> ?
     <span class="token punctuation">)</span> <span class="token keyword">AS</span> anon_1
<span class="token keyword">ON</span> assignment<span class="token punctuation">.</span>PersonId <span class="token operator">=</span> anon_1<span class="token punctuation">.</span>PersonId
</code></pre></div><h2 id="example-1-snapshot-data-stream"><a href="#example-1-snapshot-data-stream" aria-hidden="true" class="header-anchor">#</a> Example 1 - Snapshot Data Stream</h2> <p>The Snapshot data is a join between the current PersonDetail record (Name, DOB, NI Number, etc) and the current Assignment record (Organisation, Payscale, Contracted Hours, etc).  Additionally, the Organisation table provides Organisation Name.</p> <p>The criteria are:</p> <ul><li><p>Only current records are output (ref EffectiveDate at time of extract)</p></li> <li><p>Both PersonDetail and Assignment are required to be present (inner join)</p></li> <li><p>Emit the record if either record is unprocessed, even if the other record has processed status</p></li> <li><p>Organisation is optional (outer join) - if missing, an error code is substituted for the name</p></li></ul> <h3 id="record-selection"><a href="#record-selection" aria-hidden="true" class="header-anchor">#</a> Record Selection</h3> <p>The SqlAlchemy query for selecting Snapshot data is:</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">def</span> <span class="token function">select</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
    query <span class="token operator">=</span> self<span class="token punctuation">.</span>session<span class="token punctuation">.</span>query<span class="token punctuation">(</span><span class="token operator">*</span>self<span class="token punctuation">.</span>extract_columns<span class="token punctuation">)</span> \
        <span class="token punctuation">.</span>join<span class="token punctuation">(</span>Assignment<span class="token punctuation">,</span> Assignment<span class="token punctuation">.</span>PersonId <span class="token operator">==</span> PersonDetail<span class="token punctuation">.</span>Id<span class="token punctuation">)</span> \
        <span class="token punctuation">.</span>outerjoin<span class="token punctuation">(</span>Organisation<span class="token punctuation">,</span> Assignment<span class="token punctuation">.</span>OrganisationId <span class="token operator">==</span> Organisation<span class="token punctuation">.</span>Id<span class="token punctuation">)</span> \
        <span class="token punctuation">.</span><span class="token builtin">filter</span><span class="token punctuation">(</span>Assignment<span class="token punctuation">.</span>EffectiveDate <span class="token operator">&lt;=</span> self<span class="token punctuation">.</span>effective_date<span class="token punctuation">)</span> \
        <span class="token punctuation">.</span><span class="token builtin">filter</span><span class="token punctuation">(</span>Assignment<span class="token punctuation">.</span>EffectiveEndDate <span class="token operator">&gt;=</span> self<span class="token punctuation">.</span>effective_date<span class="token punctuation">)</span> \
        <span class="token punctuation">.</span><span class="token builtin">filter</span><span class="token punctuation">(</span>PersonDetail<span class="token punctuation">.</span>EffectiveDate <span class="token operator">&lt;=</span> self<span class="token punctuation">.</span>effective_date<span class="token punctuation">)</span> \
        <span class="token punctuation">.</span><span class="token builtin">filter</span><span class="token punctuation">(</span>PersonDetail<span class="token punctuation">.</span>EffectiveEndDate <span class="token operator">&gt;=</span> self<span class="token punctuation">.</span>effective_date<span class="token punctuation">)</span> \
        <span class="token punctuation">.</span><span class="token builtin">filter</span><span class="token punctuation">(</span>or_<span class="token punctuation">(</span>Assignment<span class="token punctuation">.</span>StateValue <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">,</span> PersonDetail<span class="token punctuation">.</span>StateValue <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    self<span class="token punctuation">.</span>selection <span class="token operator">=</span> query<span class="token punctuation">.</span><span class="token builtin">all</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><p>which produces the SQL statement:</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">SELECT</span>
  person_detail<span class="token punctuation">.</span><span class="token string">&quot;Id&quot;</span> <span class="token keyword">AS</span> <span class="token string">&quot;person_detail_Id&quot;</span><span class="token punctuation">,</span>
  person_detail<span class="token punctuation">.</span><span class="token string">&quot;EffectiveDate&quot;</span> <span class="token keyword">AS</span> <span class="token string">&quot;person_detail_EffectiveDate&quot;</span><span class="token punctuation">,</span>
  person_detail<span class="token punctuation">.</span><span class="token string">&quot;EmployeeNumber&quot;</span> <span class="token keyword">AS</span> <span class="token string">&quot;person_detail_EmployeeNumber&quot;</span><span class="token punctuation">,</span>
  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
  assignment<span class="token punctuation">.</span><span class="token string">&quot;Id&quot;</span> <span class="token keyword">AS</span> <span class="token string">&quot;assignment_Id&quot;</span><span class="token punctuation">,</span>
  assignment<span class="token punctuation">.</span><span class="token string">&quot;AssignmentNumber&quot;</span> <span class="token keyword">AS</span> <span class="token string">&quot;assignment_AssignmentNumber&quot;</span><span class="token punctuation">,</span>
  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
  organisation<span class="token punctuation">.</span><span class="token string">&quot;OrganisationName&quot;</span> <span class="token keyword">AS</span> <span class="token string">&quot;organisation_OrganisationName&quot;</span><span class="token punctuation">,</span>
<span class="token keyword">FROM</span> person_detail
<span class="token keyword">JOIN</span> assignment <span class="token keyword">ON</span> assignment<span class="token punctuation">.</span><span class="token string">&quot;PersonId&quot;</span> <span class="token operator">=</span> person_detail<span class="token punctuation">.</span><span class="token string">&quot;Id&quot;</span>
<span class="token keyword">LEFT</span> <span class="token keyword">OUTER</span> <span class="token keyword">JOIN</span> organisation <span class="token keyword">ON</span> assignment<span class="token punctuation">.</span><span class="token string">&quot;OrganisationId&quot;</span> <span class="token operator">=</span> organisation<span class="token punctuation">.</span><span class="token string">&quot;Id&quot;</span>
<span class="token keyword">WHERE</span>      assignment<span class="token punctuation">.</span><span class="token string">&quot;EffectiveDate&quot;</span> <span class="token operator">&lt;=</span> ?
<span class="token operator">AND</span>        assignment<span class="token punctuation">.</span><span class="token string">&quot;EffectiveEndDate&quot;</span> <span class="token operator">&gt;=</span> ?
<span class="token operator">AND</span>        person_detail<span class="token punctuation">.</span><span class="token string">&quot;EffectiveDate&quot;</span> <span class="token operator">&lt;=</span> ?
<span class="token operator">AND</span>        person_detail<span class="token punctuation">.</span><span class="token string">&quot;EffectiveEndDate&quot;</span> <span class="token operator">&gt;=</span> ?
<span class="token operator">AND</span>        organisation<span class="token punctuation">.</span><span class="token string">&quot;EffectiveDate&quot;</span> <span class="token operator">&lt;=</span> ?
<span class="token operator">AND</span>        organisation<span class="token punctuation">.</span><span class="token string">&quot;EffectiveEndDate&quot;</span> <span class="token operator">&gt;=</span> ?
<span class="token operator">AND</span>        <span class="token punctuation">(</span>assignment<span class="token punctuation">.</span><span class="token string">&quot;StateValue&quot;</span> <span class="token operator">=</span> ? <span class="token operator">OR</span> person_detail<span class="token punctuation">.</span><span class="token string">&quot;StateValue&quot;</span> <span class="token operator">=</span> ?<span class="token punctuation">)</span>
</code></pre></div><h3 id="joins"><a href="#joins" aria-hidden="true" class="header-anchor">#</a> Joins</h3> <h4 id="extract-specific-joins"><a href="#extract-specific-joins" aria-hidden="true" class="header-anchor">#</a> Extract-Specific Joins</h4> <p>Since the tables are keyed on Id + EffectiveDate, it’s difficult to define a foreign key relationship between tables.</p> <p>Strictly speaking, at any one date there is a one-to-many relationship between PersonDetail and Assignment, because there can only be one PersonDetail record on a date but there can be many overlapping Assignments.</p> <p>However, the records are keyed by their start dates and these will differ between the tables, so an FK cannot be defined in the database.</p> <p>Therefore, we treat the join criteria as use-case specific. This is useful because a globally defined relationship creates a dependency between different extract use-cases. We can can adjust the relationship used in the Snapshot extract without impacting other extracts.</p> <h4 id="implicit-primary-table"><a href="#implicit-primary-table" aria-hidden="true" class="header-anchor">#</a> Implicit Primary Table</h4> <p>In the inner join from PersonDetail to Assignment, PersonDetail is the “primary” table because it is the first table referenced in the extract_columns list (the list of columns to be selected).</p> <p>This means the join function is</p> <p><code>.join(Assignment, Assignment.PersonId == PersonDetail.Id)</code></p> <p>and not</p> <p><code>.join(PersonDetail, Assignment.PersonId == PersonDetail.Id)</code></p> <p>which would give a runtime error.</p> <h4 id="relaxed-join-for-error-correction"><a href="#relaxed-join-for-error-correction" aria-hidden="true" class="header-anchor">#</a> Relaxed Join for Error Correction</h4> <p>The second join is an outer join between Assignment and Organisation to obtain the OrganisationName column. In the business context, this is a mandatory join - the Assignment makes no sense if there is no Organisation linked to it.</p> <p>During testing it was found that some assignments had a reference to a non-existent organisation, which clearly is an error. However, it was decided to substitute an error code for the missing Organisation name and allow the data to proceed. To enable this, an outer join is used in the query.</p> <h3 id="extract-columns"><a href="#extract-columns" aria-hidden="true" class="header-anchor">#</a> Extract Columns</h3> <p>The table columns to be extracted are defined in the extract_columns property. Specifying the required columns reduces the width of data extracted from the database.</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">class</span> <span class="token class-name">SnapshotGenerator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> db<span class="token punctuation">,</span> effective_date<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>extract_columns <span class="token operator">=</span> <span class="token punctuation">[</span>PersonDetail<span class="token punctuation">.</span>Id<span class="token punctuation">,</span>
                                PersonDetail<span class="token punctuation">.</span>EffectiveDate<span class="token punctuation">,</span>
                                PersonDetail<span class="token punctuation">.</span>EmployeeNumber<span class="token punctuation">,</span>
                                PersonDetail<span class="token punctuation">.</span>LastName<span class="token punctuation">,</span>
                                PersonDetail<span class="token punctuation">.</span>FirstName<span class="token punctuation">,</span>
                                PersonDetail<span class="token punctuation">.</span>MiddleNames<span class="token punctuation">,</span>
                                PersonDetail<span class="token punctuation">.</span>Title<span class="token punctuation">,</span>
                                PersonDetail<span class="token punctuation">.</span>NationalInsuranceNumber<span class="token punctuation">,</span>
                                PersonDetail<span class="token punctuation">.</span>DateOfBirth<span class="token punctuation">,</span>
                                PersonDetail<span class="token punctuation">.</span>NHSStartDate<span class="token punctuation">,</span>
                                Assignment<span class="token punctuation">.</span>Id<span class="token punctuation">,</span>
                                Assignment<span class="token punctuation">.</span>AssignmentNumber<span class="token punctuation">,</span>
                                Assignment<span class="token punctuation">.</span>OrganisationId<span class="token punctuation">,</span>
                                Organisation<span class="token punctuation">.</span>OrganisationName<span class="token punctuation">,</span>
                                Assignment<span class="token punctuation">.</span>Grade<span class="token punctuation">,</span>
                                Assignment<span class="token punctuation">.</span>PositionName<span class="token punctuation">,</span>
                                Assignment<span class="token punctuation">.</span>PayrollName<span class="token punctuation">,</span>
                                Assignment<span class="token punctuation">.</span>FTE<span class="token punctuation">,</span>
                                Assignment<span class="token punctuation">.</span>NormalHoursSessions<span class="token punctuation">,</span>
                                Assignment<span class="token punctuation">.</span>PrimaryAssignment<span class="token punctuation">,</span>
                                Assignment<span class="token punctuation">.</span>EffectiveDate<span class="token punctuation">,</span>
                                Assignment<span class="token punctuation">.</span>EffectiveEndDate<span class="token punctuation">]</span>
</code></pre></div><p>Most of these columns are passed to the GatewaySnapshotRecord class to create the DTO to send to Gateway, but we also extract the Id’s and EffectiveDate’s of PersonDetail and Assignment so that the records can be marked as processed.</p> <h3 id="setting-processed-status"><a href="#setting-processed-status" aria-hidden="true" class="header-anchor">#</a> Setting Processed Status</h3> <p>Once a record has been sent to Gateway it is marked as processed in the database so that that it will not be sent in the next run. This only occurs if the row has not encountered fatal errors in the Validate() method and therefore would not have been sent.</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">def</span> <span class="token function">mark_as_processed</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">for</span> row <span class="token keyword">in</span> self<span class="token punctuation">.</span>selection<span class="token punctuation">:</span>
        <span class="token keyword">if</span> <span class="token operator">not</span> row<span class="token punctuation">.</span>has_fatal_errors<span class="token punctuation">:</span>
            assignment <span class="token operator">=</span> self<span class="token punctuation">.</span>db<span class="token punctuation">.</span>get<span class="token punctuation">(</span>Assignment<span class="token punctuation">,</span> self<span class="token punctuation">.</span>_get_keys<span class="token punctuation">(</span>Assignment<span class="token punctuation">,</span> row<span class="token punctuation">)</span><span class="token punctuation">)</span>
            assignment<span class="token punctuation">.</span>StateValue <span class="token operator">=</span> <span class="token number">1</span>
            person_detail <span class="token operator">=</span> self<span class="token punctuation">.</span>db<span class="token punctuation">.</span>get<span class="token punctuation">(</span>PersonDetail<span class="token punctuation">,</span> self<span class="token punctuation">.</span>_get_keys<span class="token punctuation">(</span>PersonDetail<span class="token punctuation">,</span> row<span class="token punctuation">)</span><span class="token punctuation">)</span>
            person_detail<span class="token punctuation">.</span>StateValue <span class="token operator">=</span> <span class="token number">1</span>
    self<span class="token punctuation">.</span>db<span class="token punctuation">.</span>commit<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">_get_keys</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> _type<span class="token punctuation">,</span> row<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>row<span class="token punctuation">[</span>self<span class="token punctuation">.</span>extract_columns<span class="token punctuation">.</span>index<span class="token punctuation">(</span>_type<span class="token punctuation">.</span>Id<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            row<span class="token punctuation">[</span>self<span class="token punctuation">.</span>extract_columns<span class="token punctuation">.</span>index<span class="token punctuation">(</span>_type<span class="token punctuation">.</span>EffectiveDate<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre></div><h2 id="example-2-assignment-changes"><a href="#example-2-assignment-changes" aria-hidden="true" class="header-anchor">#</a> Example 2 - Assignment Changes</h2> <p>Assignments can vary over time, so are stored with a combined key of Id + EffectiveDate. This extract requires all future-dated assignments to be processed as a set. Note that the person may have more than one active assignment. These are treated as independent sets.</p> <p>The criteria for selection are:</p> <ul><li><p>Only current and future records are output</p></li> <li><p>Emit the full set of records if any record in the set is unprocessed.</p></li> <li><p>Organisation is optional (outer join) - if missing, an error message is substituted for the name</p></li></ul> <h3 id="record-selection-2"><a href="#record-selection-2" aria-hidden="true" class="header-anchor">#</a> Record Selection</h3> <p>This extract requires a table self-join, which can be done in two ways in SqlAlchemy.</p> <h4 id="subquery-version"><a href="#subquery-version" aria-hidden="true" class="header-anchor">#</a> Subquery Version</h4> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">def</span> <span class="token function">select</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
    person_select_sub_query <span class="token operator">=</span> self<span class="token punctuation">.</span>session<span class="token punctuation">.</span>query<span class="token punctuation">(</span>Assignment<span class="token punctuation">.</span>PersonId<span class="token punctuation">)</span> \
      <span class="token punctuation">.</span><span class="token builtin">filter</span><span class="token punctuation">(</span>Assignment<span class="token punctuation">.</span>EffectiveEndDate <span class="token operator">&gt;=</span> self<span class="token punctuation">.</span>effective_date<span class="token punctuation">)</span> \
      <span class="token punctuation">.</span><span class="token builtin">filter</span><span class="token punctuation">(</span>Assignment<span class="token punctuation">.</span>StateValue <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> \
      <span class="token punctuation">.</span>distinct<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>subquery<span class="token punctuation">(</span><span class="token punctuation">)</span>

    query <span class="token operator">=</span> self<span class="token punctuation">.</span>session<span class="token punctuation">.</span>query<span class="token punctuation">(</span><span class="token operator">*</span>self<span class="token punctuation">.</span>extract_columns<span class="token punctuation">)</span> \
        <span class="token punctuation">.</span>outerjoin<span class="token punctuation">(</span>Organisation<span class="token punctuation">,</span> Assignment<span class="token punctuation">.</span>OrganisationId <span class="token operator">==</span> Organisation<span class="token punctuation">.</span>Id<span class="token punctuation">)</span> \
        <span class="token punctuation">.</span><span class="token builtin">filter</span><span class="token punctuation">(</span>Assignment<span class="token punctuation">.</span>EffectiveEndDate <span class="token operator">&gt;=</span> self<span class="token punctuation">.</span>effective_date<span class="token punctuation">)</span> \
        <span class="token punctuation">.</span><span class="token builtin">filter</span><span class="token punctuation">(</span>Assignment<span class="token punctuation">.</span>PersonId <span class="token operator">==</span> person_select_sub_query<span class="token punctuation">.</span>c<span class="token punctuation">.</span>PersonId<span class="token punctuation">)</span>

    self<span class="token punctuation">.</span>selection <span class="token operator">=</span> query<span class="token punctuation">.</span><span class="token builtin">all</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><p>which produces the SQL statement:</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">SELECT</span>
  assignment<span class="token punctuation">.</span><span class="token string">&quot;PersonId&quot;</span> <span class="token keyword">AS</span> <span class="token string">&quot;assignment_PersonId&quot;</span><span class="token punctuation">,</span>
  assignment<span class="token punctuation">.</span><span class="token string">&quot;Id&quot;</span> <span class="token keyword">AS</span> <span class="token string">&quot;assignment_Id&quot;</span><span class="token punctuation">,</span>
  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
  organisation<span class="token punctuation">.</span><span class="token string">&quot;OrganisationName&quot;</span> <span class="token keyword">AS</span> <span class="token string">&quot;organisation_OrganisationName&quot;</span>
<span class="token keyword">FROM</span>
  <span class="token punctuation">(</span>
    <span class="token keyword">SELECT</span> <span class="token keyword">DISTINCT</span> assignment<span class="token punctuation">.</span><span class="token string">&quot;PersonId&quot;</span> <span class="token keyword">AS</span> <span class="token string">&quot;PersonId&quot;</span>
    <span class="token keyword">FROM</span> assignment
    <span class="token keyword">WHERE</span> assignment<span class="token punctuation">.</span><span class="token string">&quot;EffectiveEndDate&quot;</span> <span class="token operator">&gt;=</span> ? <span class="token operator">AND</span> assignment<span class="token punctuation">.</span><span class="token string">&quot;StateValue&quot;</span> <span class="token operator">=</span> ?
  <span class="token punctuation">)</span> <span class="token keyword">AS</span> anon_1<span class="token punctuation">,</span>
  assignment
  <span class="token keyword">LEFT</span> <span class="token keyword">OUTER</span> <span class="token keyword">JOIN</span> organisation <span class="token keyword">ON</span> assignment<span class="token punctuation">.</span><span class="token string">&quot;OrganisationId&quot;</span> <span class="token operator">=</span> organisation<span class="token punctuation">.</span><span class="token string">&quot;Id&quot;</span>
  <span class="token keyword">WHERE</span> assignment<span class="token punctuation">.</span><span class="token string">&quot;EffectiveEndDate&quot;</span> <span class="token operator">&gt;=</span> ?
  <span class="token operator">AND</span>   assignment<span class="token punctuation">.</span><span class="token string">&quot;PersonId&quot;</span> <span class="token operator">=</span> anon_1<span class="token punctuation">.</span><span class="token string">&quot;PersonId&quot;</span>
</code></pre></div><h4 id="aliased-table-version"><a href="#aliased-table-version" aria-hidden="true" class="header-anchor">#</a> Aliased Table Version</h4> <div class="language-python extra-class"><pre class="language-python"><code>assignment_set_selector <span class="token operator">=</span> aliased<span class="token punctuation">(</span>Assignment<span class="token punctuation">)</span>

query <span class="token operator">=</span> self<span class="token punctuation">.</span>session<span class="token punctuation">.</span>query<span class="token punctuation">(</span><span class="token operator">*</span>self<span class="token punctuation">.</span>extract_columns<span class="token punctuation">)</span> \
    <span class="token punctuation">.</span>join<span class="token punctuation">(</span>assignment_set_selector<span class="token punctuation">,</span> Assignment<span class="token punctuation">.</span>PersonId <span class="token operator">==</span> \
      assignment_set_selector<span class="token punctuation">.</span>PersonId<span class="token punctuation">)</span> \
    <span class="token punctuation">.</span>outerjoin<span class="token punctuation">(</span>Organisation<span class="token punctuation">,</span> Assignment<span class="token punctuation">.</span>OrganisationId <span class="token operator">==</span> Organisation<span class="token punctuation">.</span>Id<span class="token punctuation">)</span> \
    <span class="token punctuation">.</span><span class="token builtin">filter</span><span class="token punctuation">(</span>assignment_set_selector<span class="token punctuation">.</span>EffectiveEndDate <span class="token operator">&gt;=</span> self<span class="token punctuation">.</span>effective_date<span class="token punctuation">)</span> \
    <span class="token punctuation">.</span><span class="token builtin">filter</span><span class="token punctuation">(</span>assignment_set_selector<span class="token punctuation">.</span>StateValue <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> \
    <span class="token punctuation">.</span><span class="token builtin">filter</span><span class="token punctuation">(</span>Assignment<span class="token punctuation">.</span>EffectiveEndDate <span class="token operator">&gt;=</span> self<span class="token punctuation">.</span>effective_date<span class="token punctuation">)</span> \
    <span class="token punctuation">.</span>distinct<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><p>which produces the SQL statement:</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">SELECT</span> <span class="token keyword">DISTINCT</span>
  assignment<span class="token punctuation">.</span><span class="token string">&quot;PersonId&quot;</span> <span class="token keyword">AS</span> <span class="token string">&quot;assignment_PersonId&quot;</span><span class="token punctuation">,</span>
  assignment<span class="token punctuation">.</span><span class="token string">&quot;Id&quot;</span> <span class="token keyword">AS</span> <span class="token string">&quot;assignment_Id&quot;</span><span class="token punctuation">,</span>
  assignment<span class="token punctuation">.</span><span class="token string">&quot;AssignmentNumber&quot;</span> <span class="token keyword">AS</span> <span class="token string">&quot;assignment_AssignmentNumber&quot;</span><span class="token punctuation">,</span>
  assignment<span class="token punctuation">.</span><span class="token string">&quot;EffectiveDate&quot;</span> <span class="token keyword">AS</span> <span class="token string">&quot;assignment_EffectiveDate&quot;</span><span class="token punctuation">,</span>
  assignment<span class="token punctuation">.</span><span class="token string">&quot;NormalHoursSessions&quot;</span> <span class="token keyword">AS</span> <span class="token string">&quot;assignment_NormalHoursSessions&quot;</span><span class="token punctuation">,</span>
  assignment<span class="token punctuation">.</span><span class="token string">&quot;Grade&quot;</span> <span class="token keyword">AS</span> <span class="token string">&quot;assignment_Grade&quot;</span><span class="token punctuation">,</span>
  assignment<span class="token punctuation">.</span><span class="token string">&quot;PayrollName&quot;</span> <span class="token keyword">AS</span> <span class="token string">&quot;assignment_PayrollName&quot;</span><span class="token punctuation">,</span>
  assignment<span class="token punctuation">.</span><span class="token string">&quot;PositionName&quot;</span> <span class="token keyword">AS</span> <span class="token string">&quot;assignment_PositionName&quot;</span><span class="token punctuation">,</span>
  assignment<span class="token punctuation">.</span><span class="token string">&quot;OrganisationId&quot;</span> <span class="token keyword">AS</span> <span class="token string">&quot;assignment_OrganisationId&quot;</span><span class="token punctuation">,</span>
  organisation<span class="token punctuation">.</span><span class="token string">&quot;OrganisationName&quot;</span> <span class="token keyword">AS</span> <span class="token string">&quot;organisation_OrganisationName&quot;</span>
<span class="token keyword">FROM</span> assignment
<span class="token keyword">JOIN</span> assignment <span class="token keyword">AS</span> assignment_1 <span class="token keyword">ON</span> assignment<span class="token punctuation">.</span><span class="token string">&quot;PersonId&quot;</span> <span class="token operator">=</span> assignment_1<span class="token punctuation">.</span><span class="token string">&quot;PersonId&quot;</span>
<span class="token keyword">LEFT</span> <span class="token keyword">OUTER</span> <span class="token keyword">JOIN</span> organisation <span class="token keyword">ON</span> assignment<span class="token punctuation">.</span><span class="token string">&quot;OrganisationId&quot;</span> <span class="token operator">=</span> organisation<span class="token punctuation">.</span><span class="token string">&quot;Id&quot;</span>
<span class="token keyword">WHERE</span> assignment_1<span class="token punctuation">.</span><span class="token string">&quot;EffectiveEndDate&quot;</span> <span class="token operator">&gt;=</span> ?
<span class="token operator">AND</span> assignment_1<span class="token punctuation">.</span><span class="token string">&quot;StateValue&quot;</span> <span class="token operator">=</span> ?
<span class="token operator">AND</span> assignment<span class="token punctuation">.</span><span class="token string">&quot;EffectiveEndDate&quot;</span> <span class="token operator">&gt;=</span> ?
</code></pre></div><div class="minimap-container" style="width:250px;" data-v-5674b532><div class="minimap" style="top:250px;zoom:25%;" data-v-5674b532><div data-v-5674b532></div></div></div></div> <div class="page-edit"><!----> <!----></div> <!----> </div> <!----></div></div>
    <script src="/esrgo-python-documentation/assets/js/11.d1c152da.js" defer></script><script src="/esrgo-python-documentation/assets/js/5.92ce2759.js" defer></script><script src="/esrgo-python-documentation/assets/js/app.08b8ebf7.js" defer></script>
  </body>
</html>
