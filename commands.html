<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Commands | C# Interface port to Python</title>
    <meta name="description" content="C# Interface port to Python">
    
    
    <link rel="preload" href="/esrgo-python-documentation/assets/css/styles.08b8ebf7.css" as="style"><link rel="preload" href="/esrgo-python-documentation/assets/js/app.08b8ebf7.js" as="script"><link rel="preload" href="/esrgo-python-documentation/assets/js/8.3d242c4d.js" as="script"><link rel="preload" href="/esrgo-python-documentation/assets/css/5.styles.92ce2759.css" as="style"><link rel="preload" href="/esrgo-python-documentation/assets/js/5.92ce2759.js" as="script"><link rel="prefetch" href="/esrgo-python-documentation/assets/css/1.styles.dacdc8f1.css"><link rel="prefetch" href="/esrgo-python-documentation/assets/js/1.dacdc8f1.js"><link rel="prefetch" href="/esrgo-python-documentation/assets/css/2.styles.6df4aee8.css"><link rel="prefetch" href="/esrgo-python-documentation/assets/js/2.6df4aee8.js"><link rel="prefetch" href="/esrgo-python-documentation/assets/css/3.styles.62e3bade.css"><link rel="prefetch" href="/esrgo-python-documentation/assets/js/3.62e3bade.js"><link rel="prefetch" href="/esrgo-python-documentation/assets/js/4.e0e8277f.js"><link rel="prefetch" href="/esrgo-python-documentation/assets/js/6.b3d7e6cd.js"><link rel="prefetch" href="/esrgo-python-documentation/assets/js/7.fcd4ff92.js"><link rel="prefetch" href="/esrgo-python-documentation/assets/js/9.234d134d.js"><link rel="prefetch" href="/esrgo-python-documentation/assets/js/10.fb3d3e85.js"><link rel="prefetch" href="/esrgo-python-documentation/assets/js/11.d1c152da.js"><link rel="prefetch" href="/esrgo-python-documentation/assets/js/12.db983685.js"><link rel="prefetch" href="/esrgo-python-documentation/assets/js/13.542e130d.js"><link rel="prefetch" href="/esrgo-python-documentation/assets/js/14.bf07540b.js"><link rel="prefetch" href="/esrgo-python-documentation/assets/js/15.123c7fb9.js"><link rel="prefetch" href="/esrgo-python-documentation/assets/js/16.8c7136bb.js"><link rel="prefetch" href="/esrgo-python-documentation/assets/js/17.4bf3763a.js"><link rel="prefetch" href="/esrgo-python-documentation/assets/js/18.19d247d1.js"><link rel="prefetch" href="/esrgo-python-documentation/assets/js/19.a9221979.js">
    <link rel="stylesheet" href="/esrgo-python-documentation/assets/css/5.styles.92ce2759.css"><link rel="stylesheet" href="/esrgo-python-documentation/assets/css/styles.08b8ebf7.css"><link rel="stylesheet" href="/esrgo-python-documentation/assets/css/1.styles.dacdc8f1.css"><link rel="stylesheet" href="/esrgo-python-documentation/assets/css/2.styles.6df4aee8.css"><link rel="stylesheet" href="/esrgo-python-documentation/assets/css/3.styles.62e3bade.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/esrgo-python-documentation/" class="home-link router-link-active"><!----> <span class="site-name">C# Interface port to Python</span></a> <div class="links" style="max-width:nullpx;"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/esrgo-python-documentation/" class="nav-link">Overview</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">Domain Model</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/esrgo-python-documentation/domain-generation.html" class="nav-link">Domain Model Code Generation</a></li><li class="dropdown-item"><!----> <a href="/esrgo-python-documentation/serializing-objects.html" class="nav-link">Serializing Objects in Correct Order</a></li><li class="dropdown-item"><!----> <a href="/esrgo-python-documentation/initializing-model-classes.html" class="nav-link">Initializing Model Classes</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">Processing</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/esrgo-python-documentation/commands.html" class="nav-link router-link-exact-active router-link-active">Commands</a></li><li class="dropdown-item"><!----> <a href="/esrgo-python-documentation/csv-processing.html" class="nav-link">CSV Processing</a></li><li class="dropdown-item"><!----> <a href="/esrgo-python-documentation/file-handling-with-regex.html" class="nav-link">File Handling with Regex</a></li><li class="dropdown-item"><!----> <a href="/esrgo-python-documentation/logging-with-xml-serialization.html" class="nav-link">Logging with XML Serialization</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">SqlAlchemy</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/esrgo-python-documentation/extracting-data-with-sqlalchemy.html" class="nav-link">Extracting Data with SqlAlchemy ORM</a></li><li class="dropdown-item"><!----> <a href="/esrgo-python-documentation/query-windowing-with-sqlalchemy.html" class="nav-link">Query Windowing with SqlAlchemy ORM</a></li><li class="dropdown-item"><!----> <a href="/esrgo-python-documentation/query-windowing-with-a-filter-criteria.html" class="nav-link">Query Windowing with a Filter Criteria</a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/esrgo-python-documentation/" class="nav-link">Overview</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">Domain Model</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/esrgo-python-documentation/domain-generation.html" class="nav-link">Domain Model Code Generation</a></li><li class="dropdown-item"><!----> <a href="/esrgo-python-documentation/serializing-objects.html" class="nav-link">Serializing Objects in Correct Order</a></li><li class="dropdown-item"><!----> <a href="/esrgo-python-documentation/initializing-model-classes.html" class="nav-link">Initializing Model Classes</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">Processing</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/esrgo-python-documentation/commands.html" class="nav-link router-link-exact-active router-link-active">Commands</a></li><li class="dropdown-item"><!----> <a href="/esrgo-python-documentation/csv-processing.html" class="nav-link">CSV Processing</a></li><li class="dropdown-item"><!----> <a href="/esrgo-python-documentation/file-handling-with-regex.html" class="nav-link">File Handling with Regex</a></li><li class="dropdown-item"><!----> <a href="/esrgo-python-documentation/logging-with-xml-serialization.html" class="nav-link">Logging with XML Serialization</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">SqlAlchemy</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/esrgo-python-documentation/extracting-data-with-sqlalchemy.html" class="nav-link">Extracting Data with SqlAlchemy ORM</a></li><li class="dropdown-item"><!----> <a href="/esrgo-python-documentation/query-windowing-with-sqlalchemy.html" class="nav-link">Query Windowing with SqlAlchemy ORM</a></li><li class="dropdown-item"><!----> <a href="/esrgo-python-documentation/query-windowing-with-a-filter-criteria.html" class="nav-link">Query Windowing with a Filter Criteria</a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><div class="sidebar-group first"><p class="sidebar-heading open"><span>Commands</span> <!----></p> <ul class="sidebar-group-items"><li><a href="/esrgo-python-documentation/commands.html#overview" class="sidebar-link">Overview</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/esrgo-python-documentation/commands.html#init-and-do-it" class="sidebar-link">Init and Do_It</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/esrgo-python-documentation/commands.html#mocking-dependencies" class="sidebar-link">Mocking Dependencies</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/esrgo-python-documentation/commands.html#comments-on-language-and-syntax" class="sidebar-link">Comments on language and syntax</a><ul class="sidebar-sub-headers"></ul></li></ul></div></li></ul> </div> <div class="page"> <div class="content"><h1 id="commands"><a href="#commands" aria-hidden="true" class="header-anchor">#</a> Commands</h1> <h2 id="overview"><a href="#overview" aria-hidden="true" class="header-anchor">#</a> Overview</h2> <p>Commands are simple classes which perform (or orchestrate) the functions of the application. They will typically correspond to the use-cases of the system, so they are useful as a focal point for understanding the code.</p> <p>Bob Martin says that an application architecture should show it’s  intent, not what technology it’s built on. Commands are a good way to do that (Bob calls them Interactors).</p> <p>As well as code clarity, we can also use them for:</p> <ul><li><p>Representing use-cases, and a focus for functional / acceptance tests</p></li> <li><p>Encourage DCI practices, which is about moving process code out of entity methods and into their own class (or group of classes)</p></li> <li><p>Providing a DSL for a process-oriented application by allowing configuration or command line composition</p></li> <li><p>Scalability, by passing command instances to back-end servers for processing</p></li></ul> <h2 id="init-and-do-it"><a href="#init-and-do-it" aria-hidden="true" class="header-anchor">#</a> Init and Do_It</h2> <p>The <code>__init__</code> method of the class defines the local class properties. In a command class, we use it to initialize resources used in the process, but do not invoke any processing here. This happens in the <strong>do_it</strong> method, which is the start method, invoked externally to the command.</p> <p>This separation of initialization and processing gives tests the opportunity to mock out resources. Since Python is dynamic, an object can be “recomposed” by a test that creates it - that is, any property or method can be replaced for mocking or logging method invocation but this requires separation of initialization and invocation.</p> <p>The UpdateRepository command listed below illustrates the pattern:</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">class</span> <span class="token class-name">UpdateRepositoryCommand</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> settings<span class="token operator">=</span>application_settings<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>settings <span class="token operator">=</span> settings
        <span class="token keyword">if</span> self<span class="token punctuation">.</span>settings<span class="token punctuation">.</span>database <span class="token operator">==</span> <span class="token string">'MsSqlServer'</span><span class="token punctuation">:</span>
            db_uri <span class="token operator">=</span> <span class="token string">&quot;mssql+pyodbc://%s&quot;</span> <span class="token operator">%</span> self<span class="token punctuation">.</span>settings<span class="token punctuation">.</span>dsn_name
            self<span class="token punctuation">.</span>db <span class="token operator">=</span> MsSqlGenericSqlRepository<span class="token punctuation">(</span>db_uri<span class="token punctuation">)</span>
        <span class="token keyword">elif</span> self<span class="token punctuation">.</span>settings<span class="token punctuation">.</span>database <span class="token operator">==</span> <span class="token string">'RavenDb'</span><span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>db <span class="token operator">=</span> RavenDbRepository<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">elif</span> self<span class="token punctuation">.</span>settings<span class="token punctuation">.</span>database <span class="token operator">==</span> <span class="token string">'SqlLite'</span><span class="token punctuation">:</span>
            db_uri <span class="token operator">=</span> <span class="token string">'sqlite:////'</span> <span class="token operator">+</span> self<span class="token punctuation">.</span>settings<span class="token punctuation">.</span>sqlite_db_path
            self<span class="token punctuation">.</span>db <span class="token operator">=</span> SqliteRepository<span class="token punctuation">(</span>db_uri<span class="token punctuation">)</span>
        <span class="token keyword">elif</span> self<span class="token punctuation">.</span>settings<span class="token punctuation">.</span>database <span class="token operator">==</span> <span class="token string">'PostgreSql'</span><span class="token punctuation">:</span>
            <span class="token keyword">raise</span> NotImplementedError
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            <span class="token keyword">raise</span> TypeError<span class="token punctuation">(</span><span class="token string">'Invalid database specified in settings'</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>directory_scanner <span class="token operator">=</span>
          InboundDirectoryScanner<span class="token punctuation">(</span>
            directory_path<span class="token operator">=</span>self<span class="token punctuation">.</span>settings<span class="token punctuation">.</span>ersgo_local_in_path<span class="token punctuation">,</span>
            vpd<span class="token operator">=</span>self<span class="token punctuation">.</span>settings<span class="token punctuation">.</span>vpd<span class="token punctuation">,</span>
            last_sequence_number_processed<span class="token operator">=</span>self<span class="token punctuation">.</span>settings<span class="token punctuation">.</span>last_sequence_number_processed<span class="token punctuation">,</span>
            files_to_process<span class="token operator">=</span>self<span class="token punctuation">.</span>settings<span class="token punctuation">.</span>files_to_process<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>batch_handler <span class="token operator">=</span>
          BatchHandler<span class="token punctuation">(</span>
            batch_size<span class="token operator">=</span>self<span class="token punctuation">.</span>settings<span class="token punctuation">.</span>sql_loader_batch_handler_batch_size<span class="token punctuation">,</span>
            on_batch_full<span class="token operator">=</span>self<span class="token punctuation">.</span>db<span class="token punctuation">.</span>commit<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>file_processor <span class="token operator">=</span> CsvFileProcessor<span class="token punctuation">(</span>ParserMapping<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>events <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        self<span class="token punctuation">.</span>errors <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        self<span class="token punctuation">.</span>staging_error <span class="token operator">=</span> <span class="token boolean">None</span>
        self<span class="token punctuation">.</span>error_originating_module <span class="token operator">=</span> <span class="token boolean">None</span>
        self<span class="token punctuation">.</span>verbose <span class="token operator">=</span> self<span class="token punctuation">.</span>settings<span class="token punctuation">.</span>verbose
        self<span class="token punctuation">.</span>process_run_audit <span class="token operator">=</span> ProcessRunAudit<span class="token punctuation">(</span>self<span class="token punctuation">.</span>settings<span class="token punctuation">.</span>audit_path<span class="token punctuation">)</span>

        <span class="token comment"># Hooks for mocking in tests</span>
        self<span class="token punctuation">.</span>bulk_insert_command <span class="token operator">=</span> ProcessStagingRecordsSqlBulkInsert
        self<span class="token punctuation">.</span>process_sql_command <span class="token operator">=</span> ProcessStagingRecordsSql
        self<span class="token punctuation">.</span>process_raven_command <span class="token operator">=</span> ProcessStagingRecordsRavenDb

    <span class="token keyword">def</span> <span class="token function">do_it</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>process_run_audit<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">try</span><span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>directory_scanner<span class="token punctuation">.</span>scan<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">for</span> <span class="token builtin">file</span> <span class="token keyword">in</span> self<span class="token punctuation">.</span>directory_scanner<span class="token punctuation">.</span>files_included<span class="token punctuation">:</span>
                <span class="token keyword">with</span> StagingFileErrors<span class="token punctuation">(</span><span class="token builtin">file</span><span class="token punctuation">.</span>file_name<span class="token punctuation">,</span> self<span class="token punctuation">.</span>settings<span class="token punctuation">.</span>audit_path<span class="token punctuation">)</span> 
                <span class="token keyword">as</span> self<span class="token punctuation">.</span>staging_error<span class="token punctuation">:</span>
                    self<span class="token punctuation">.</span>process_file<span class="token punctuation">(</span><span class="token builtin">file</span><span class="token punctuation">)</span>
                <span class="token keyword">if</span> self<span class="token punctuation">.</span>staging_error<span class="token punctuation">.</span>error_count<span class="token punctuation">:</span>
                    self<span class="token punctuation">.</span>errors<span class="token punctuation">.</span>append<span class="token punctuation">(</span>self<span class="token punctuation">.</span>staging_error<span class="token punctuation">.</span>summary<span class="token punctuation">)</span>
        <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>error_originating_module <span class="token operator">=</span> originating_module<span class="token punctuation">(</span><span class="token punctuation">)</span>
            msg <span class="token operator">=</span> <span class="token string">'An error occurred in command UpdateRepository ({0}):, {1}'</span>\
                <span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>error_originating_module<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">)</span>
            error <span class="token operator">=</span> UnexpectedError<span class="token punctuation">(</span>msg<span class="token punctuation">)</span>
            self<span class="token punctuation">.</span>errors<span class="token punctuation">.</span>append<span class="token punctuation">(</span>error<span class="token punctuation">)</span>
        <span class="token keyword">finally</span><span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>_write_audit<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><h2 id="mocking-dependencies"><a href="#mocking-dependencies" aria-hidden="true" class="header-anchor">#</a> Mocking Dependencies</h2> <p>Python doesn’t have dependency injection in as formal a way as C#. In C# you must program to an interface, which gives a hook for substituting mock objects in test scenarios. In Python, you can just replace components of the SUT with mocks directly, in between the SUT initialization and call to the method to be tested.</p> <p>In both languages, the dependency must be exposed as a property of the SUT. In the code above, three sub-commands are exposed as properties purely in order to allow them to be mocked.</p> <h2 id="comments-on-language-and-syntax"><a href="#comments-on-language-and-syntax" aria-hidden="true" class="header-anchor">#</a> Comments on language and syntax</h2> <p>The first thing that a static language programmer notices is the lack of formal property definitions. You need to scan the <code>__init__</code> method to work out what properties the class has (those initialized with the self prefix), and this a convention only - properties can be initialized elsewhere in the class methods, although this is flagged by PyCharm.</p> <p>The use of “self.” everywhere feels a little cluttered. It is necessary to designate scope, in case a similar name is declared globally - but it would be nicer if the scope within a class was automatically limited to the class properties and methods only, so that self could be dropped.</p> <div class="minimap-container" style="width:250px;" data-v-5674b532><div class="minimap" style="top:250px;zoom:25%;" data-v-5674b532><div data-v-5674b532></div></div></div></div> <div class="page-edit"><!----> <!----></div> <!----> </div> <!----></div></div>
    <script src="/esrgo-python-documentation/assets/js/8.3d242c4d.js" defer></script><script src="/esrgo-python-documentation/assets/js/5.92ce2759.js" defer></script><script src="/esrgo-python-documentation/assets/js/app.08b8ebf7.js" defer></script>
  </body>
</html>
