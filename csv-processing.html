<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>CSV Processing | C# Interface port to Python</title>
    <meta name="description" content="C# Interface port to Python">
    
    
    <link rel="preload" href="/esrgo-python-documentation/assets/css/styles.08b8ebf7.css" as="style"><link rel="preload" href="/esrgo-python-documentation/assets/js/app.08b8ebf7.js" as="script"><link rel="preload" href="/esrgo-python-documentation/assets/js/9.234d134d.js" as="script"><link rel="preload" href="/esrgo-python-documentation/assets/css/5.styles.92ce2759.css" as="style"><link rel="preload" href="/esrgo-python-documentation/assets/js/5.92ce2759.js" as="script"><link rel="prefetch" href="/esrgo-python-documentation/assets/css/1.styles.dacdc8f1.css"><link rel="prefetch" href="/esrgo-python-documentation/assets/js/1.dacdc8f1.js"><link rel="prefetch" href="/esrgo-python-documentation/assets/css/2.styles.6df4aee8.css"><link rel="prefetch" href="/esrgo-python-documentation/assets/js/2.6df4aee8.js"><link rel="prefetch" href="/esrgo-python-documentation/assets/css/3.styles.62e3bade.css"><link rel="prefetch" href="/esrgo-python-documentation/assets/js/3.62e3bade.js"><link rel="prefetch" href="/esrgo-python-documentation/assets/js/4.e0e8277f.js"><link rel="prefetch" href="/esrgo-python-documentation/assets/js/6.b3d7e6cd.js"><link rel="prefetch" href="/esrgo-python-documentation/assets/js/7.fcd4ff92.js"><link rel="prefetch" href="/esrgo-python-documentation/assets/js/8.3d242c4d.js"><link rel="prefetch" href="/esrgo-python-documentation/assets/js/10.fb3d3e85.js"><link rel="prefetch" href="/esrgo-python-documentation/assets/js/11.d1c152da.js"><link rel="prefetch" href="/esrgo-python-documentation/assets/js/12.db983685.js"><link rel="prefetch" href="/esrgo-python-documentation/assets/js/13.542e130d.js"><link rel="prefetch" href="/esrgo-python-documentation/assets/js/14.bf07540b.js"><link rel="prefetch" href="/esrgo-python-documentation/assets/js/15.123c7fb9.js"><link rel="prefetch" href="/esrgo-python-documentation/assets/js/16.8c7136bb.js"><link rel="prefetch" href="/esrgo-python-documentation/assets/js/17.4bf3763a.js"><link rel="prefetch" href="/esrgo-python-documentation/assets/js/18.19d247d1.js"><link rel="prefetch" href="/esrgo-python-documentation/assets/js/19.a9221979.js">
    <link rel="stylesheet" href="/esrgo-python-documentation/assets/css/5.styles.92ce2759.css"><link rel="stylesheet" href="/esrgo-python-documentation/assets/css/styles.08b8ebf7.css"><link rel="stylesheet" href="/esrgo-python-documentation/assets/css/1.styles.dacdc8f1.css"><link rel="stylesheet" href="/esrgo-python-documentation/assets/css/2.styles.6df4aee8.css"><link rel="stylesheet" href="/esrgo-python-documentation/assets/css/3.styles.62e3bade.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/esrgo-python-documentation/" class="home-link router-link-active"><!----> <span class="site-name">C# Interface port to Python</span></a> <div class="links" style="max-width:nullpx;"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/esrgo-python-documentation/" class="nav-link">Overview</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">Domain Model</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/esrgo-python-documentation/domain-generation.html" class="nav-link">Domain Model Code Generation</a></li><li class="dropdown-item"><!----> <a href="/esrgo-python-documentation/serializing-objects.html" class="nav-link">Serializing Objects in Correct Order</a></li><li class="dropdown-item"><!----> <a href="/esrgo-python-documentation/initializing-model-classes.html" class="nav-link">Initializing Model Classes</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">Processing</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/esrgo-python-documentation/commands.html" class="nav-link">Commands</a></li><li class="dropdown-item"><!----> <a href="/esrgo-python-documentation/csv-processing.html" class="nav-link router-link-exact-active router-link-active">CSV Processing</a></li><li class="dropdown-item"><!----> <a href="/esrgo-python-documentation/file-handling-with-regex.html" class="nav-link">File Handling with Regex</a></li><li class="dropdown-item"><!----> <a href="/esrgo-python-documentation/logging-with-xml-serialization.html" class="nav-link">Logging with XML Serialization</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">SqlAlchemy</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/esrgo-python-documentation/extracting-data-with-sqlalchemy.html" class="nav-link">Extracting Data with SqlAlchemy ORM</a></li><li class="dropdown-item"><!----> <a href="/esrgo-python-documentation/query-windowing-with-sqlalchemy.html" class="nav-link">Query Windowing with SqlAlchemy ORM</a></li><li class="dropdown-item"><!----> <a href="/esrgo-python-documentation/query-windowing-with-a-filter-criteria.html" class="nav-link">Query Windowing with a Filter Criteria</a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/esrgo-python-documentation/" class="nav-link">Overview</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">Domain Model</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/esrgo-python-documentation/domain-generation.html" class="nav-link">Domain Model Code Generation</a></li><li class="dropdown-item"><!----> <a href="/esrgo-python-documentation/serializing-objects.html" class="nav-link">Serializing Objects in Correct Order</a></li><li class="dropdown-item"><!----> <a href="/esrgo-python-documentation/initializing-model-classes.html" class="nav-link">Initializing Model Classes</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">Processing</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/esrgo-python-documentation/commands.html" class="nav-link">Commands</a></li><li class="dropdown-item"><!----> <a href="/esrgo-python-documentation/csv-processing.html" class="nav-link router-link-exact-active router-link-active">CSV Processing</a></li><li class="dropdown-item"><!----> <a href="/esrgo-python-documentation/file-handling-with-regex.html" class="nav-link">File Handling with Regex</a></li><li class="dropdown-item"><!----> <a href="/esrgo-python-documentation/logging-with-xml-serialization.html" class="nav-link">Logging with XML Serialization</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">SqlAlchemy</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/esrgo-python-documentation/extracting-data-with-sqlalchemy.html" class="nav-link">Extracting Data with SqlAlchemy ORM</a></li><li class="dropdown-item"><!----> <a href="/esrgo-python-documentation/query-windowing-with-sqlalchemy.html" class="nav-link">Query Windowing with SqlAlchemy ORM</a></li><li class="dropdown-item"><!----> <a href="/esrgo-python-documentation/query-windowing-with-a-filter-criteria.html" class="nav-link">Query Windowing with a Filter Criteria</a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><div class="sidebar-group first"><p class="sidebar-heading open"><span>CSV Processing</span> <!----></p> <ul class="sidebar-group-items"><li><a href="/esrgo-python-documentation/csv-processing.html#overview" class="sidebar-link">Overview</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/esrgo-python-documentation/csv-processing.html#components" class="sidebar-link">Components</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/esrgo-python-documentation/csv-processing.html#csv-file-processor" class="sidebar-link">CSV File Processor</a></li><li class="sidebar-sub-header"><a href="/esrgo-python-documentation/csv-processing.html#csv-line-processor" class="sidebar-link">CSV Line Processor</a></li><li class="sidebar-sub-header"><a href="/esrgo-python-documentation/csv-processing.html#csv-column-processor" class="sidebar-link">CSV Column Processor</a></li><li class="sidebar-sub-header"><a href="/esrgo-python-documentation/csv-processing.html#csv-parser-mapper" class="sidebar-link">CSV Parser Mapper</a></li><li class="sidebar-sub-header"><a href="/esrgo-python-documentation/csv-processing.html#parser-classes" class="sidebar-link">Parser Classes</a></li><li class="sidebar-sub-header"><a href="/esrgo-python-documentation/csv-processing.html#parser-base" class="sidebar-link">Parser Base</a></li><li class="sidebar-sub-header"><a href="/esrgo-python-documentation/csv-processing.html#the-descriptorowner-metaclass" class="sidebar-link">The DescriptorOwner Metaclass</a></li><li class="sidebar-sub-header"><a href="/esrgo-python-documentation/csv-processing.html#descriptors" class="sidebar-link">Descriptors</a></li></ul></li></ul></div></li></ul> </div> <div class="page"> <div class="content"><h1 id="csv-processing"><a href="#csv-processing" aria-hidden="true" class="header-anchor">#</a> CSV Processing</h1> <h2 id="overview"><a href="#overview" aria-hidden="true" class="header-anchor">#</a> Overview</h2> <p>This module deals with converting CSV data into model objects, prior to storing in the local data store.</p> <figure><img src="/esrgo-python-documentation/assets/img/csv-parsing.adac2a80.png" alt="csv-parsing"> <figcaption><i>(click to enlarge)</i></figcaption></figure> <br> <h2 id="components"><a href="#components" aria-hidden="true" class="header-anchor">#</a> Components</h2> <h3 id="csv-file-processor"><a href="#csv-file-processor" aria-hidden="true" class="header-anchor">#</a> CSV File Processor</h3> <p>The CSV File Processor takes the name of a file to process and returns a stream of StagingRecords, which are containers for one or more domain entity records which have been parsed from a CSV line.</p> <p>The <code>process()</code> method contains a yield statement, and therefore returns a generator function. This minimizes the memory footprint and is able to handle arbitrarily large files.</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">import</span> csv
<span class="token keyword">from</span> CsvProcessing<span class="token punctuation">.</span>csv_line_processor <span class="token keyword">import</span> CsvLineProcessor
<span class="token keyword">from</span> CsvProcessing<span class="token punctuation">.</span>csv_processing_exceptions <span class="token keyword">import</span> UnknownRecordTypeError

<span class="token keyword">class</span> <span class="token class-name">CsvFileProcessor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> metadata_mapping<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>metadata_mapping <span class="token operator">=</span> metadata_mapping
        self<span class="token punctuation">.</span>line_number <span class="token operator">=</span> <span class="token number">0</span>  <span class="token comment"># Make it a property for external reporting of line count</span>
        self<span class="token punctuation">.</span>line_processor <span class="token operator">=</span> CsvLineProcessor<span class="token punctuation">(</span>metadata_mapping<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>errors <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>

    <span class="token keyword">def</span> <span class="token function">_get_dict_reader</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> f<span class="token punctuation">)</span><span class="token punctuation">:</span>
        _dialect <span class="token operator">=</span> csv<span class="token punctuation">.</span>Dialect
        _dialect<span class="token punctuation">.</span>delimiter <span class="token operator">=</span> <span class="token string">&quot;~&quot;</span>
        _dialect<span class="token punctuation">.</span>quoting <span class="token operator">=</span> csv<span class="token punctuation">.</span>QUOTE_NONE
        _dialect<span class="token punctuation">.</span>lineterminator <span class="token operator">=</span> <span class="token string">'\r\n'</span>
        dict_reader <span class="token operator">=</span> csv<span class="token punctuation">.</span>DictReader<span class="token punctuation">(</span>f<span class="token punctuation">,</span> fieldnames<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">&quot;RecordType&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span> restkey<span class="token operator">=</span><span class="token string">&quot;Record&quot;</span><span class="token punctuation">,</span> restval<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> dialect<span class="token operator">=</span>_dialect<span class="token punctuation">)</span>
        <span class="token keyword">return</span> dict_reader

    <span class="token keyword">def</span> <span class="token function">process</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> file_name<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">try</span><span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>line_number <span class="token operator">=</span> <span class="token number">0</span>
            <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>file_name<span class="token punctuation">,</span> newline<span class="token operator">=</span><span class="token string">''</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
                <span class="token keyword">for</span> dict_entry <span class="token keyword">in</span> self<span class="token punctuation">.</span>_get_dict_reader<span class="token punctuation">(</span>f<span class="token punctuation">)</span><span class="token punctuation">:</span>
                    self<span class="token punctuation">.</span>line_number <span class="token operator">+=</span> <span class="token number">1</span>
                    <span class="token keyword">try</span><span class="token punctuation">:</span>
                        staging_record <span class="token operator">=</span> self<span class="token punctuation">.</span>line_processor<span class="token punctuation">.</span>process_line<span class="token punctuation">(</span>dict_entry<span class="token punctuation">,</span> self<span class="token punctuation">.</span>line_number<span class="token punctuation">)</span>
                        <span class="token keyword">if</span> staging_record <span class="token keyword">is</span> <span class="token operator">not</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
                            <span class="token keyword">yield</span> staging_record
                    <span class="token keyword">except</span> UnknownRecordTypeError <span class="token keyword">as</span> e<span class="token punctuation">:</span>  <span class="token comment"># If unknown line, record error and move on</span>
                        self<span class="token punctuation">.</span>errors<span class="token punctuation">.</span>append<span class="token punctuation">(</span>e<span class="token punctuation">)</span>
        <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>errors<span class="token punctuation">.</span>append<span class="token punctuation">(</span>e<span class="token punctuation">)</span>
            <span class="token keyword">raise</span> e
</code></pre></div><h3 id="csv-line-processor"><a href="#csv-line-processor" aria-hidden="true" class="header-anchor">#</a> CSV Line Processor</h3> <h4 id="record-type"><a href="#record-type" aria-hidden="true" class="header-anchor">#</a> Record Type</h4> <p>The CSV files are non-homogenous, containing mixed record types,  so a CSV line has a record type code as the first entry, which is used to look up the appropriate parser from the ParserMapper. The parser is injected into the CSV_Line_Processor to supply specific formats (Strategy pattern).</p> <h4 id="instruction-type"><a href="#instruction-type" aria-hidden="true" class="header-anchor">#</a> Instruction Type</h4> <p>The csv line can represent one of two types of ‘instruction’:</p> <ul><li><p>‘Append’ indicates an inserted or updated record</p></li> <li><p>‘Delete’ indicates that a record has been deleted</p></li></ul> <p>A delete record is an instance of the entity with only the Id attribute filled in.</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">class</span> <span class="token class-name">CsvLineProcessor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> parser_map<span class="token punctuation">,</span> show_warnings<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>parser_map <span class="token operator">=</span> parser_map
        self<span class="token punctuation">.</span>parser <span class="token operator">=</span> <span class="token boolean">None</span>
        self<span class="token punctuation">.</span>errors <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        self<span class="token punctuation">.</span>show_warnings <span class="token operator">=</span> show_warnings
        self<span class="token punctuation">.</span>line_number <span class="token operator">=</span> <span class="token number">0</span>
        self<span class="token punctuation">.</span>record_type_code <span class="token operator">=</span> <span class="token string">''</span>
        self<span class="token punctuation">.</span>instruction_type <span class="token operator">=</span> InstructionType<span class="token punctuation">.</span>Undefined
        self<span class="token punctuation">.</span>data <span class="token operator">=</span> <span class="token boolean">None</span>
        self<span class="token punctuation">.</span>staging_record <span class="token operator">=</span> <span class="token boolean">None</span>

<span class="token operator">&lt;&lt;</span> Other code shown below<span class="token operator">&gt;&gt;</span>

<span class="token keyword">def</span> <span class="token function">make_staging_record</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
    self<span class="token punctuation">.</span>staging_record <span class="token operator">=</span> StagingRecord<span class="token punctuation">(</span><span class="token punctuation">)</span>
    self<span class="token punctuation">.</span>staging_record<span class="token punctuation">.</span>instruction_type <span class="token operator">=</span> self<span class="token punctuation">.</span>instruction_type

    <span class="token keyword">if</span> self<span class="token punctuation">.</span>instruction_type <span class="token operator">==</span> InstructionType<span class="token punctuation">.</span>Append<span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>_make_append_instance<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">elif</span> self<span class="token punctuation">.</span>instruction_type <span class="token operator">==</span> InstructionType<span class="token punctuation">.</span>Delete<span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>_make_delete_token<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        <span class="token keyword">raise</span> InvalidStagingInstructionType

    <span class="token keyword">if</span> <span class="token operator">not</span> self<span class="token punctuation">.</span>has_fatal_error<span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>staging_record<span class="token punctuation">.</span>payload<span class="token punctuation">.</span>extend<span class="token punctuation">(</span>self<span class="token punctuation">.</span>parser<span class="token punctuation">.</span>instances<span class="token punctuation">)</span>
    self<span class="token punctuation">.</span>staging_record<span class="token punctuation">.</span>errors<span class="token punctuation">.</span>extend<span class="token punctuation">(</span>self<span class="token punctuation">.</span>errors<span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">process_line</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> csv_dict_entry<span class="token punctuation">,</span> line_number<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    self<span class="token punctuation">.</span>line_number <span class="token operator">=</span> line_number
    self<span class="token punctuation">.</span>record_type_code <span class="token operator">=</span> csv_dict_entry<span class="token punctuation">[</span><span class="token string">&quot;RecordType&quot;</span><span class="token punctuation">]</span>
    self<span class="token punctuation">.</span>data <span class="token operator">=</span> csv_dict_entry<span class="token punctuation">[</span><span class="token string">&quot;Record&quot;</span><span class="token punctuation">]</span>

    <span class="token keyword">try</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>parser <span class="token operator">=</span> self<span class="token punctuation">.</span>parser_map
                          <span class="token punctuation">.</span>get_parser_from_record_type<span class="token punctuation">(</span>self<span class="token punctuation">.</span>record_type_code<span class="token punctuation">)</span>
        <span class="token keyword">if</span> self<span class="token punctuation">.</span>parser <span class="token keyword">is</span> <span class="token operator">not</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>make_staging_record<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> self<span class="token punctuation">.</span>staging_record
    <span class="token keyword">except</span> UnknownRecordTypeError <span class="token keyword">as</span> e<span class="token punctuation">:</span>
        msg <span class="token operator">=</span> <span class="token string">&quot;Unknown record at line {0}, record type code {1}&quot;</span>
              <span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>line_number<span class="token punctuation">,</span> self<span class="token punctuation">.</span>record_type_code<span class="token punctuation">)</span>
        e<span class="token punctuation">.</span>message <span class="token operator">=</span> msg
        e<span class="token punctuation">.</span>line_number <span class="token operator">=</span> self<span class="token punctuation">.</span>line_number
        self<span class="token punctuation">.</span>errors<span class="token punctuation">.</span>append<span class="token punctuation">(</span>e<span class="token punctuation">)</span>
        <span class="token keyword">raise</span> e
</code></pre></div><p>The method make_append_instance makes use of the injected Parser.</p> <ul><li><p>It takes the csv column specification from the Parser, so it does not have to know the specifics of the data format.</p></li> <li><p>It calls on the Parser to make Model object instances, and it never sees those instances. This is useful, for example, because the Australian Health CSV data contains two model types per line, whereas the NHS data contains one per line. The parser specific to the data is injected into these context objects (via the ParserMap).</p></li> <li><p>Per column, the value returned from the CSV_Column_Processor is passed into the Parser for setting on the instance record. This gives flexibility for the Australian use case, as the single PersonId column must be applied to both model instances.</p></li></ul> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">def</span> <span class="token function">_make_append_instance</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
    self<span class="token punctuation">.</span>_check_line_format<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> self<span class="token punctuation">.</span>has_fatal_error<span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token boolean">None</span>

    self<span class="token punctuation">.</span>parser<span class="token punctuation">.</span>make_instance<span class="token punctuation">(</span>self<span class="token punctuation">.</span>line_number<span class="token punctuation">)</span>

    csv_column_processor <span class="token operator">=</span> CsvColumnProcessor<span class="token punctuation">(</span>self<span class="token punctuation">.</span>line_number<span class="token punctuation">,</span> self<span class="token punctuation">.</span>show_warnings<span class="token punctuation">)</span>
    column_number <span class="token operator">=</span> <span class="token number">0</span>
    attributes_and_data <span class="token operator">=</span> zip_longest<span class="token punctuation">(</span>self<span class="token punctuation">.</span>parser<span class="token punctuation">.</span>sorted_for_csv<span class="token punctuation">,</span> self<span class="token punctuation">.</span>data<span class="token punctuation">)</span>
    <span class="token keyword">for</span> attributes<span class="token punctuation">,</span> value_raw <span class="token keyword">in</span> attributes_and_data<span class="token punctuation">:</span>
        column_number <span class="token operator">+=</span> <span class="token number">1</span>
        value <span class="token operator">=</span> csv_column_processor<span class="token punctuation">.</span>process<span class="token punctuation">(</span>column_number<span class="token punctuation">,</span> attributes<span class="token punctuation">,</span> value_raw<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>parser<span class="token punctuation">.</span><span class="token builtin">set</span><span class="token punctuation">(</span>attributes<span class="token punctuation">.</span>attribute_name<span class="token punctuation">,</span> value<span class="token punctuation">)</span>
    self<span class="token punctuation">.</span>errors<span class="token punctuation">.</span>extend<span class="token punctuation">(</span>csv_column_processor<span class="token punctuation">.</span>errors<span class="token punctuation">)</span>
</code></pre></div><h3 id="csv-column-processor"><a href="#csv-column-processor" aria-hidden="true" class="header-anchor">#</a> CSV Column Processor</h3> <p>The column processor converts the column data and traps errors if there is invalid data for the conversion or if the resulting value is outside minimum and maximum range.</p> <h4 id="conversion"><a href="#conversion" aria-hidden="true" class="header-anchor">#</a> Conversion</h4> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">def</span> <span class="token function">_convert_value</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> attributes<span class="token punctuation">,</span> value_raw<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># Set default value for nulls</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>value_raw <span class="token operator">==</span> <span class="token string">''</span> <span class="token operator">or</span> value_raw <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">)</span> <span class="token operator">and</span> attributes<span class="token punctuation">.</span>default <span class="token keyword">is</span> <span class="token operator">not</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> self<span class="token punctuation">.</span>show_warnings<span class="token punctuation">:</span>
            msg <span class="token operator">=</span> <span class="token string">'Warning: converting null value &quot;{}&quot; to default &quot;{}&quot;'</span>
                  <span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>value_raw<span class="token punctuation">,</span> attributes<span class="token punctuation">.</span>default<span class="token punctuation">)</span>
            warning <span class="token operator">=</span> NullDefaultWarning<span class="token punctuation">(</span>self<span class="token punctuation">.</span>line_number<span class="token punctuation">,</span> self<span class="token punctuation">.</span>column_number<span class="token punctuation">,</span> msg<span class="token punctuation">)</span>
            self<span class="token punctuation">.</span>errors<span class="token punctuation">.</span>append<span class="token punctuation">(</span>warning<span class="token punctuation">)</span>
        <span class="token keyword">return</span> attributes<span class="token punctuation">.</span>default

    <span class="token keyword">if</span> <span class="token operator">not</span> attributes <span class="token operator">or</span> <span class="token operator">not</span> attributes<span class="token punctuation">.</span>conversion<span class="token punctuation">:</span>
        <span class="token keyword">return</span> value_raw

    <span class="token keyword">try</span><span class="token punctuation">:</span>
        value <span class="token operator">=</span> attributes<span class="token punctuation">.</span>conversion<span class="token punctuation">(</span>value_raw<span class="token punctuation">)</span>
    <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>
        error <span class="token operator">=</span> ConversionException<span class="token punctuation">(</span>self<span class="token punctuation">.</span>line_number<span class="token punctuation">,</span> self<span class="token punctuation">.</span>column_number<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">)</span>
        error<span class="token punctuation">.</span>fix <span class="token operator">=</span> DataFix<span class="token punctuation">(</span>value_raw<span class="token punctuation">,</span> attributes<span class="token punctuation">.</span>default<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>errors<span class="token punctuation">.</span>append<span class="token punctuation">(</span>error<span class="token punctuation">)</span>
        value <span class="token operator">=</span> attributes<span class="token punctuation">.</span>default

    <span class="token keyword">return</span> value
</code></pre></div><p>Conversion functions are supplied by the Parser, so the details of how to convert are external to this context, and are specific to the data format that the Parser represents.</p> <p>For example, the NHS dates are supplied in the format ‘YYYYMMDD’ whereas the Australian form is full ISO - ‘YYYY-MM-DD HH:MM:SS’. Internally, nearly all Model object dates are handled without the time portion, so the latter converter has to truncate before converting.</p> <h4 id="range-checks"><a href="#range-checks" aria-hidden="true" class="header-anchor">#</a> Range Checks</h4> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">def</span> <span class="token function">_check_range_minimum</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> attributes<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> attributes <span class="token keyword">is</span> <span class="token boolean">None</span> <span class="token operator">or</span> attributes<span class="token punctuation">.</span>range_minimum <span class="token keyword">is</span> <span class="token boolean">None</span> <span class="token operator">or</span> value <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> value

    <span class="token keyword">if</span> value <span class="token operator">&lt;</span> attributes<span class="token punctuation">.</span>range_minimum<span class="token punctuation">:</span>
        msg <span class="token operator">=</span> <span class="token string">'Value {0} is below range minimum of {1}'</span>
              <span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> attributes<span class="token punctuation">.</span>range_minimum<span class="token punctuation">)</span>
        error <span class="token operator">=</span> RangeException<span class="token punctuation">(</span>self<span class="token punctuation">.</span>line_number<span class="token punctuation">,</span> self<span class="token punctuation">.</span>column_number<span class="token punctuation">,</span> msg<span class="token punctuation">)</span>
        error<span class="token punctuation">.</span>fix <span class="token operator">=</span> DataFix<span class="token punctuation">(</span>value<span class="token punctuation">,</span> attributes<span class="token punctuation">.</span>default<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>errors<span class="token punctuation">.</span>append<span class="token punctuation">(</span>error<span class="token punctuation">)</span>
        <span class="token keyword">return</span> attributes<span class="token punctuation">.</span>default
    <span class="token keyword">return</span> value

<span class="token keyword">def</span> <span class="token function">_check_range_maximum</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> attributes<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> attributes <span class="token keyword">is</span> <span class="token boolean">None</span> <span class="token operator">or</span> attributes<span class="token punctuation">.</span>range_maximum <span class="token keyword">is</span> <span class="token boolean">None</span> <span class="token operator">or</span> value <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> value
    <span class="token keyword">if</span> value <span class="token operator">&gt;</span> attributes<span class="token punctuation">.</span>range_maximum<span class="token punctuation">:</span>
        msg <span class="token operator">=</span> <span class="token string">'Value {0} is above range maximum of {1}'</span>
              <span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> attributes<span class="token punctuation">.</span>range_maximum<span class="token punctuation">)</span>
        error <span class="token operator">=</span> RangeException<span class="token punctuation">(</span>self<span class="token punctuation">.</span>line_number<span class="token punctuation">,</span> self<span class="token punctuation">.</span>column_number<span class="token punctuation">,</span> msg<span class="token punctuation">)</span>
        error<span class="token punctuation">.</span>fix <span class="token operator">=</span> DataFix<span class="token punctuation">(</span>value<span class="token punctuation">,</span> attributes<span class="token punctuation">.</span>default<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>errors<span class="token punctuation">.</span>append<span class="token punctuation">(</span>error<span class="token punctuation">)</span>
        <span class="token keyword">return</span> attributes<span class="token punctuation">.</span>default
    <span class="token keyword">return</span> value
</code></pre></div><h3 id="csv-parser-mapper"><a href="#csv-parser-mapper" aria-hidden="true" class="header-anchor">#</a> CSV Parser Mapper</h3> <p>This is a fairly simple lookup table between the record type code form the CSV data line and an instance of a CSV Parser class. Note that the parsers are instantiated once per process run and re-used for each line of the type.</p> <h4 id="uninteresting-lines"><a href="#uninteresting-lines" aria-hidden="true" class="header-anchor">#</a> Uninteresting Lines</h4> <p>Some lines in the file, such as Header and Trailer, are not processed so these are mapped to None. The Absence and Training records aren’t used, so they are also mapped to None. This causes the line to be skipped in the line processor.</p> <h4 id="unknown-lines"><a href="#unknown-lines" aria-hidden="true" class="header-anchor">#</a> Unknown Lines</h4> <p>If we get a line with an unspecified record type an error is raised, so in this way we can distinguish between uninteresting and invalid records.</p> <h4 id="instruction-type-2"><a href="#instruction-type-2" aria-hidden="true" class="header-anchor">#</a> Instruction Type</h4> <p>As mentioned above, each type can have an ‘Append’ or ‘Delete’ instruction, which is indicated by the third character of the code. The same parser is used for both instruction types, so only the first two characters are matched for records of interest.</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">class</span> <span class="token class-name">ParserMapping</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>parser_mapping <span class="token operator">=</span> \
            <span class="token builtin">dict</span><span class="token punctuation">(</span>HDR<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span>  <span class="token comment"># File header</span>
                 AD<span class="token operator">=</span>address_parser<span class="token punctuation">.</span>AddressParser<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                 AS<span class="token operator">=</span>assignment_parser<span class="token punctuation">.</span>AssignmentParser<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                 CO<span class="token operator">=</span>assignment_costing_parser<span class="token punctuation">.</span>AssignmentCostingParser<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                 CM<span class="token operator">=</span>competence_parser<span class="token punctuation">.</span>CompetenceParser<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                 CR<span class="token operator">=</span>contact_relationship_parser<span class="token punctuation">.</span>ContactRelationshipParser<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                 ET<span class="token operator">=</span>extended_information_type_parser<span class="token punctuation">.</span>ExtendedInformationTypeParser<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                 LC<span class="token operator">=</span>location_parser<span class="token punctuation">.</span>LocationParser<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                 OR<span class="token operator">=</span>organisation_parser<span class="token punctuation">.</span>OrganisationParser<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                 PR<span class="token operator">=</span>person_detail_parser<span class="token punctuation">.</span>PersonDetailParser<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                 PH<span class="token operator">=</span>phone_parser<span class="token punctuation">.</span>PhoneParser<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                 PO<span class="token operator">=</span>position_parser<span class="token punctuation">.</span>PositionParser<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                 QL<span class="token operator">=</span>qualification_parser<span class="token punctuation">.</span>QualificationParser<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                 ST<span class="token operator">=</span>special_information_type_parser<span class="token punctuation">.</span>SpecialInformationTypeParser<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                 TR<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span>  <span class="token comment"># training records not used</span>
                 AB<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span>  <span class="token comment"># absence records not used</span>
                 TRL<span class="token operator">=</span><span class="token boolean">None</span>  <span class="token comment"># File trailer )</span>

     <span class="token keyword">def</span> <span class="token function">get_parser_from_record_type</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> record_type<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">try</span><span class="token punctuation">:</span>
            <span class="token keyword">return</span> self<span class="token punctuation">.</span>parser_mapping<span class="token punctuation">[</span>record_type<span class="token punctuation">]</span>  <span class="token comment"># Try the full record_type</span>
        <span class="token keyword">except</span> KeyError<span class="token punctuation">:</span>
            <span class="token keyword">if</span> record_type<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">]</span> <span class="token operator">not</span> <span class="token keyword">in</span> <span class="token punctuation">(</span><span class="token string">'A'</span><span class="token punctuation">,</span> <span class="token string">'D'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment"># A = Append, D = Delete</span>
                <span class="token keyword">raise</span> UnknownRecordTypeError<span class="token punctuation">(</span>record_type<span class="token punctuation">)</span>
            <span class="token keyword">try</span><span class="token punctuation">:</span>
                parser <span class="token operator">=</span> self<span class="token punctuation">.</span>parser_mapping<span class="token punctuation">[</span>record_type<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">]</span>
                <span class="token keyword">return</span> parser
            <span class="token keyword">except</span> KeyError<span class="token punctuation">:</span>
                <span class="token keyword">raise</span> UnknownRecordTypeError<span class="token punctuation">(</span>record_type<span class="token punctuation">)</span>
</code></pre></div><h3 id="parser-classes"><a href="#parser-classes" aria-hidden="true" class="header-anchor">#</a> Parser Classes</h3> <p>The parser classes (generated from the XML domain object definitions) are largely declarative in style, with a few simple methods that hook into the Context processors as described above.</p> <ul><li><p>The CSV columns are class attributes set by Descriptors which define the column types.</p></li> <li><p>The make_instance method creates a new instance of the target Model object (or objects in the case of the Australian specification).</p></li> <li><p>The set method applies processed data values, and can be applied to multiple targets if required.</p></li> <li><p>The instances property returns completed objects when called.</p></li></ul> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">class</span> <span class="token class-name">AddressParser</span><span class="token punctuation">(</span>ParserBase<span class="token punctuation">,</span> metaclass<span class="token operator">=</span>DescriptorOwner<span class="token punctuation">)</span><span class="token punctuation">:</span>
    address <span class="token operator">=</span> <span class="token boolean">None</span>
    PersonId <span class="token operator">=</span> IntDescriptor<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
    Id <span class="token operator">=</span> IntDescriptor<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    AddressType <span class="token operator">=</span> StringDescriptor<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
    AddressStyle <span class="token operator">=</span> StringDescriptor<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>
    PrimaryFlag <span class="token operator">=</span> BoolDescriptor<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span>
    AddressFirstLine <span class="token operator">=</span> StringDescriptor<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span>
    AddressSecondLine <span class="token operator">=</span> StringDescriptor<span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span>
    AddressThirdLine <span class="token operator">=</span> StringDescriptor<span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">)</span>
    AddressTown <span class="token operator">=</span> StringDescriptor<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span>
    AddressCounty <span class="token operator">=</span> StringDescriptor<span class="token punctuation">(</span><span class="token number">9</span><span class="token punctuation">)</span>
    AddressPostcode <span class="token operator">=</span> StringDescriptor<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span>
    AddressCountry <span class="token operator">=</span> StringDescriptor<span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span>
    EffectiveDate <span class="token operator">=</span> StartDateDescriptor<span class="token punctuation">(</span><span class="token number">12</span><span class="token punctuation">)</span>
    EffectiveEndDate <span class="token operator">=</span> EndDateDescriptor<span class="token punctuation">(</span><span class="token number">13</span><span class="token punctuation">)</span>
    LastUpdateDate <span class="token operator">=</span> DateTimeDescriptor<span class="token punctuation">(</span><span class="token number">14</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">make_instance</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> line_number<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>address <span class="token operator">=</span> Address<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>address<span class="token punctuation">.</span>TransportLineNo <span class="token operator">=</span> line_number

    <span class="token keyword">def</span> <span class="token function">set</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> attribute_name<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">setattr</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>address<span class="token punctuation">,</span> attribute_name<span class="token punctuation">,</span> value<span class="token punctuation">)</span>

    @<span class="token builtin">property</span>
    <span class="token keyword">def</span> <span class="token function">instances</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token punctuation">[</span>self<span class="token punctuation">.</span>address<span class="token punctuation">]</span>
</code></pre></div><h3 id="parser-base"><a href="#parser-base" aria-hidden="true" class="header-anchor">#</a> Parser Base</h3> <p>The ParserBase class contains some plumbing for the parsers, which keeps the derived classes fairly lean. Two methods are provided for programmatically altering the column definition Descriptors, for use in unit tests.</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">class</span> <span class="token class-name">ParserBase</span><span class="token punctuation">(</span>metaclass<span class="token operator">=</span>ABCMeta<span class="token punctuation">)</span><span class="token punctuation">:</span>
    descriptor_list <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    descriptors <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>descriptors <span class="token operator">=</span> self<span class="token punctuation">.</span>__class__<span class="token punctuation">.</span>descriptor_list<span class="token punctuation">[</span>self<span class="token punctuation">.</span>__class__<span class="token punctuation">.</span>__name__<span class="token punctuation">]</span>
        self<span class="token punctuation">.</span>column_count <span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>descriptors<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>optional_ragged_right_columns <span class="token operator">=</span> <span class="token number">0</span>

    @abstractmethod
    <span class="token keyword">def</span> <span class="token function">make_instance</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> line_number<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">pass</span>

    @abstractmethod
    <span class="token keyword">def</span> <span class="token function">set</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> attribute_name<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">pass</span>

    @abstractproperty
    <span class="token keyword">def</span> <span class="token function">instances</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">pass</span>

    @<span class="token builtin">property</span>
    <span class="token keyword">def</span> <span class="token function">sorted_for_csv</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token builtin">sorted</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>descriptors<span class="token punctuation">,</span> key<span class="token operator">=</span><span class="token keyword">lambda</span> x<span class="token punctuation">:</span> x<span class="token punctuation">.</span>column_order<span class="token punctuation">)</span>

    @<span class="token builtin">property</span>
    <span class="token keyword">def</span> <span class="token function">attribute_names</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token punctuation">[</span>a<span class="token punctuation">.</span>attribute_name <span class="token keyword">for</span> a <span class="token keyword">in</span> self<span class="token punctuation">.</span>sorted_for_csv<span class="token punctuation">]</span>

    @<span class="token builtin">property</span>
    <span class="token keyword">def</span> <span class="token function">mandatory_column_count</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> self<span class="token punctuation">.</span>column_count <span class="token operator">-</span> self<span class="token punctuation">.</span>optional_ragged_right_columns

    <span class="token comment"># Used for programmatic access to column definitions in tests</span>
    <span class="token keyword">def</span> <span class="token function">get_metadata</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> attribute_name<span class="token punctuation">)</span><span class="token punctuation">:</span>
        descriptor <span class="token operator">=</span> <span class="token punctuation">[</span>a <span class="token keyword">for</span> a <span class="token keyword">in</span> self<span class="token punctuation">.</span>descriptors 
                      <span class="token keyword">if</span> a<span class="token punctuation">.</span>attribute_name <span class="token operator">==</span> attribute_name<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
        <span class="token keyword">return</span> descriptor <span class="token keyword">if</span> descriptor <span class="token keyword">else</span> <span class="token boolean">None</span>

    <span class="token keyword">def</span> <span class="token function">set_metadata</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> attribute_name<span class="token punctuation">,</span> prop<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">:</span>
        descriptor <span class="token operator">=</span> <span class="token punctuation">[</span>d <span class="token keyword">for</span> d <span class="token keyword">in</span> self<span class="token punctuation">.</span>descriptors 
                      <span class="token keyword">if</span> d<span class="token punctuation">.</span>attribute_name <span class="token operator">==</span> attribute_name<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
        <span class="token keyword">if</span> descriptor <span class="token operator">and</span> <span class="token builtin">hasattr</span><span class="token punctuation">(</span>descriptor<span class="token punctuation">,</span> prop<span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token builtin">setattr</span><span class="token punctuation">(</span>descriptor<span class="token punctuation">,</span> prop<span class="token punctuation">,</span> value<span class="token punctuation">)</span>
</code></pre></div><h3 id="the-descriptorowner-metaclass"><a href="#the-descriptorowner-metaclass" aria-hidden="true" class="header-anchor">#</a> The DescriptorOwner Metaclass</h3> <p>During entity creation the DescriptorOwner metaclass:</p> <ul><li><p>records the name of the attribute within the descriptor so that we can use setattr()</p></li> <li><p>records attribute names in a list for merging with CSV data to create the object dictionary</p></li></ul> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">class</span> <span class="token class-name">DescriptorOwner</span><span class="token punctuation">(</span>ABCMeta<span class="token punctuation">,</span> <span class="token builtin">type</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__new__</span><span class="token punctuation">(</span>cls<span class="token punctuation">,</span> name<span class="token punctuation">,</span> bases<span class="token punctuation">,</span> attrs<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># find all descriptors, auto-set their labels</span>
        cls_instance <span class="token operator">=</span> <span class="token builtin">super</span><span class="token punctuation">(</span>DescriptorOwner<span class="token punctuation">,</span> cls<span class="token punctuation">)</span><span class="token punctuation">.</span>__new__<span class="token punctuation">(</span>cls<span class="token punctuation">,</span> name<span class="token punctuation">,</span> bases<span class="token punctuation">,</span> attrs<span class="token punctuation">)</span>
        descriptors <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        <span class="token keyword">for</span> n<span class="token punctuation">,</span> v <span class="token keyword">in</span> attrs<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">if</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>v<span class="token punctuation">,</span> CsvDescriptorBase<span class="token punctuation">)</span><span class="token punctuation">:</span>
                v<span class="token punctuation">.</span>attribute_name <span class="token operator">=</span> n
                <span class="token comment"># record the descriptor</span>
                descriptors<span class="token punctuation">.</span>append<span class="token punctuation">(</span>v<span class="token punctuation">)</span>
        cls_instance<span class="token punctuation">.</span>descriptor_list<span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> descriptors
        <span class="token keyword">return</span> cls_instance
</code></pre></div><h3 id="descriptors"><a href="#descriptors" aria-hidden="true" class="header-anchor">#</a> Descriptors</h3> <p>There are seven Descriptors which define the column types required to parse the CSV data.</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">from</span> Utility<span class="token punctuation">.</span>date_constants <span class="token keyword">import</span> bot<span class="token punctuation">,</span> eot<span class="token punctuation">,</span> bot_datetime
<span class="token keyword">from</span> CsvProcessing<span class="token punctuation">.</span>NhsStagingRecords<span class="token punctuation">.</span>conversions <span class="token keyword">import</span> to_int<span class="token punctuation">,</span> to_decimal<span class="token punctuation">,</span> to_bool<span class="token punctuation">,</span> to_date<span class="token punctuation">,</span> to_datetime

<span class="token keyword">class</span> <span class="token class-name">IntDescriptor</span><span class="token punctuation">(</span>CsvDescriptorBase<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> col_order<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>column_order <span class="token operator">=</span> col_order
        self<span class="token punctuation">.</span>default <span class="token operator">=</span> <span class="token number">0</span>
        self<span class="token punctuation">.</span>conversion <span class="token operator">=</span> to_int
        self<span class="token punctuation">.</span>range_min <span class="token operator">=</span> <span class="token number">0</span>

<span class="token keyword">class</span> <span class="token class-name">DecimalDescriptor</span><span class="token punctuation">(</span>CsvDescriptorBase<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> col_order<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>column_order <span class="token operator">=</span> col_order
        self<span class="token punctuation">.</span>default <span class="token operator">=</span> Decimal<span class="token punctuation">(</span><span class="token number">0.0</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>conversion <span class="token operator">=</span> to_decimal
        self<span class="token punctuation">.</span>range_min <span class="token operator">=</span> Decimal<span class="token punctuation">(</span><span class="token number">0.0</span><span class="token punctuation">)</span>

<span class="token keyword">class</span> <span class="token class-name">StringDescriptor</span><span class="token punctuation">(</span>CsvDescriptorBase<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> col_order<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>column_order <span class="token operator">=</span> col_order
        self<span class="token punctuation">.</span>default <span class="token operator">=</span> <span class="token string">''</span>

<span class="token keyword">class</span> <span class="token class-name">BoolDescriptor</span><span class="token punctuation">(</span>CsvDescriptorBase<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> col_order<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>column_order <span class="token operator">=</span> col_order
        self<span class="token punctuation">.</span>default <span class="token operator">=</span> <span class="token boolean">False</span>
        self<span class="token punctuation">.</span>conversion <span class="token operator">=</span> to_bool

<span class="token keyword">class</span> <span class="token class-name">DateDescriptor</span><span class="token punctuation">(</span>CsvDescriptorBase<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> col_order<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>column_order <span class="token operator">=</span> col_order
        self<span class="token punctuation">.</span>default <span class="token operator">=</span> bot
        self<span class="token punctuation">.</span>conversion <span class="token operator">=</span> to_date
        self<span class="token punctuation">.</span>range_minimum <span class="token operator">=</span> bot
        self<span class="token punctuation">.</span>range_maximum <span class="token operator">=</span> eot

<span class="token keyword">class</span> <span class="token class-name">EndDateDescriptor</span><span class="token punctuation">(</span>DateDescriptor<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> col_order<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span>col_order<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>default <span class="token operator">=</span> eot

<span class="token keyword">class</span> <span class="token class-name">DateTimeDescriptor</span><span class="token punctuation">(</span>CsvDescriptorBase<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> col_order<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>column_order <span class="token operator">=</span> col_order
        self<span class="token punctuation">.</span>default <span class="token operator">=</span> bot_datetime
        self<span class="token punctuation">.</span>conversion <span class="token operator">=</span> to_datetime
        self<span class="token punctuation">.</span>range_minimum <span class="token operator">=</span> bot_datetime
</code></pre></div><p>Note that the EndDateDescriptor inherits from DateDescriptor and just changes the default value.</p> <p>The <strong>CsvDescriptorBase</strong> class provides default values for the attributes which are overridden in the subclasses above as appropriate.</p> <p>Note that there is no code in the setter or getter. The setting of instance attribute values is done by the set() method of the Parser. If done through the Descriptor setter, the value would end up on the Parser not the target instance. Likewise with the getter below, although there’s not really a need to read out the data - it’s all about setting data.</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">class</span> <span class="token class-name">CsvDescriptorBase</span><span class="token punctuation">(</span>metaclass<span class="token operator">=</span>ABCMeta<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> <span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>attribute_name <span class="token operator">=</span> <span class="token boolean">None</span>
        self<span class="token punctuation">.</span>column_order <span class="token operator">=</span> <span class="token number">0</span>
        self<span class="token punctuation">.</span>default <span class="token operator">=</span> <span class="token boolean">None</span>
        self<span class="token punctuation">.</span>conversion <span class="token operator">=</span> <span class="token boolean">None</span>
        self<span class="token punctuation">.</span>range_minimum <span class="token operator">=</span> <span class="token boolean">None</span>
        self<span class="token punctuation">.</span>range_maximum <span class="token operator">=</span> <span class="token boolean">None</span>

    <span class="token keyword">def</span> <span class="token function">__get__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> instance<span class="token punctuation">,</span> owner<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">pass</span>

    <span class="token keyword">def</span> <span class="token function">__set__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> instance<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">pass</span>

    <span class="token keyword">def</span> <span class="token function">__repr__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token string">&quot;{}, order: {}, attribute: {}&quot;</span>
               <span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span><span class="token builtin">type</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">.</span>__name__<span class="token punctuation">,</span> self<span class="token punctuation">.</span>column_order<span class="token punctuation">,</span> self<span class="token punctuation">.</span>attribute_name<span class="token punctuation">)</span>
</code></pre></div><div class="minimap-container" style="width:250px;" data-v-5674b532><div class="minimap" style="top:250px;zoom:25%;" data-v-5674b532><div data-v-5674b532></div></div></div></div> <div class="page-edit"><!----> <!----></div> <!----> </div> <!----></div></div>
    <script src="/esrgo-python-documentation/assets/js/9.234d134d.js" defer></script><script src="/esrgo-python-documentation/assets/js/5.92ce2759.js" defer></script><script src="/esrgo-python-documentation/assets/js/app.08b8ebf7.js" defer></script>
  </body>
</html>
