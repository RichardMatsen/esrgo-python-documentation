(window.webpackJsonp=window.webpackJsonp||[]).push([[15],{226:function(t,s,a){"use strict";a.r(s);var n=a(1),e=Object(n.a)({},function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("div",{staticClass:"content"},[t._m(0),t._v(" "),t._m(1),t._v(" "),a("p",[t._v("This question https://groups.google.com/forum/#!topic/sqlalchemy/d6JJ4z1hQyo highlighted a very good point about the WindowedRangeQuery recipe, that is the interval query acts on the whole table and ignores WHERE clauses applied to the base query. It turns out this is quite easy to change.")]),t._v(" "),t._m(2),t._v(" "),a("p",[t._v("To start with, add an additional optional parameter to the QueryWindow constructor:")]),t._v(" "),t._m(3),t._m(4),t._v(" "),t._m(5),a("p",[t._v("Note that _get_intervalquery is split off from _get_intervals, to allow checking of the SQL statement in tests.")]),t._v(" "),t._m(6),t._v(" "),a("p",[t._v("In SqlAlchemy the filter expression can be stated directly:")]),t._v(" "),t._m(7),t._m(8),t._v(" "),t._m(9),t._m(10),t._v(" "),t._m(11),a("MiniMap")],1)},[function(){var t=this.$createElement,s=this._self._c||t;return s("h1",{attrs:{id:"query-windowing-with-a-filter-criteria"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#query-windowing-with-a-filter-criteria","aria-hidden":"true"}},[this._v("#")]),this._v(" Query Windowing with a Filter Criteria")])},function(){var t=this.$createElement,s=this._self._c||t;return s("h2",{attrs:{id:"adding-a-where-clause-to-the-base-query"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#adding-a-where-clause-to-the-base-query","aria-hidden":"true"}},[this._v("#")]),this._v(" Adding a WHERE clause to the Base Query")])},function(){var t=this.$createElement,s=this._self._c||t;return s("h3",{attrs:{id:"pass-an-optional-table-filter"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#pass-an-optional-table-filter","aria-hidden":"true"}},[this._v("#")]),this._v(" Pass an optional table_filter")])},function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("div",{staticClass:"language-python extra-class"},[a("pre",{pre:!0,attrs:{class:"language-python"}},[a("code",[a("span",{attrs:{class:"token keyword"}},[t._v("class")]),t._v(" "),a("span",{attrs:{class:"token class-name"}},[t._v("QueryWindow")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),a("span",{attrs:{class:"token keyword"}},[t._v("def")]),t._v(" "),a("span",{attrs:{class:"token function"}},[t._v("__init__")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("self"),a("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" query"),a("span",{attrs:{class:"token operator"}},[t._v("=")]),a("span",{attrs:{class:"token boolean"}},[t._v("None")]),a("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" window_size"),a("span",{attrs:{class:"token operator"}},[t._v("=")]),a("span",{attrs:{class:"token number"}},[t._v("0")]),a("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" break_column"),a("span",{attrs:{class:"token operator"}},[t._v("=")]),a("span",{attrs:{class:"token boolean"}},[t._v("None")]),a("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n                 table_filter"),a("span",{attrs:{class:"token operator"}},[t._v("=")]),a("span",{attrs:{class:"token boolean"}},[t._v("None")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n        self"),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("query "),a("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" query\n        "),a("span",{attrs:{class:"token keyword"}},[t._v("if")]),t._v(" break_column "),a("span",{attrs:{class:"token keyword"}},[t._v("is")]),t._v(" "),a("span",{attrs:{class:"token boolean"}},[t._v("None")]),a("span",{attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n            break_column "),a("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" self"),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("get_primary_key"),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("query"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n        self"),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("break_column "),a("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" break_column\n        self"),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("window_size "),a("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" window_size\n        self"),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("intervals "),a("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{attrs:{class:"token boolean"}},[t._v("None")]),t._v("\n        self"),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{attrs:{class:"token builtin"}},[t._v("filter")]),t._v(" "),a("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" table_filter\n")])])])},function(){var t=this.$createElement,s=this._self._c||t;return s("h3",{attrs:{id:"apply-it-to-the-interval-query"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#apply-it-to-the-interval-query","aria-hidden":"true"}},[this._v("#")]),this._v(" Apply it to the interval query")])},function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("div",{staticClass:"language-python extra-class"},[a("pre",{pre:!0,attrs:{class:"language-python"}},[a("code",[a("span",{attrs:{class:"token keyword"}},[t._v("def")]),t._v(" "),a("span",{attrs:{class:"token function"}},[t._v("_get_intervals")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("self"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    q "),a("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" self"),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("_get_interval_query"),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    interval_starts "),a("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("[")]),t._v("start_value "),a("span",{attrs:{class:"token keyword"}},[t._v("for")]),t._v(" start_value"),a("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{attrs:{class:"token keyword"}},[t._v("in")]),t._v(" q"),a("span",{attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n    self"),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("intervals "),a("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("[")]),t._v("QueryWindowInterval"),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("self"),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("query"),a("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" self"),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("break_column"),a("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" start"),a("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" end"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n                      "),a("span",{attrs:{class:"token keyword"}},[t._v("for")]),t._v(" start"),a("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" end "),a("span",{attrs:{class:"token keyword"}},[t._v("in")]),t._v(" "),a("span",{attrs:{class:"token builtin"}},[t._v("zip")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("interval_starts"),a("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" interval_starts"),a("span",{attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{attrs:{class:"token number"}},[t._v("1")]),a("span",{attrs:{class:"token punctuation"}},[t._v(":")]),a("span",{attrs:{class:"token punctuation"}},[t._v("]")]),t._v("  \n                      "),a("span",{attrs:{class:"token operator"}},[t._v("+")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{attrs:{class:"token boolean"}},[t._v("None")]),a("span",{attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n\n"),a("span",{attrs:{class:"token keyword"}},[t._v("def")]),t._v(" "),a("span",{attrs:{class:"token function"}},[t._v("_get_interval_query")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("self"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    session "),a("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" self"),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("query"),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("session\n    q "),a("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" session"),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("query"),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("self"),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("break_column"),a("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n                      func"),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("row_number"),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n                      "),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("over"),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("order_by"),a("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v("self"),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("break_column"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n                      "),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("label"),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token string"}},[t._v("'rownum'")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),a("span",{attrs:{class:"token keyword"}},[t._v("if")]),t._v(" self"),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{attrs:{class:"token builtin"}},[t._v("filter")]),t._v(" "),a("span",{attrs:{class:"token keyword"}},[t._v("is")]),t._v(" "),a("span",{attrs:{class:"token operator"}},[t._v("not")]),t._v(" "),a("span",{attrs:{class:"token boolean"}},[t._v("None")]),a("span",{attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n        q "),a("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" q"),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{attrs:{class:"token builtin"}},[t._v("filter")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("self"),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{attrs:{class:"token builtin"}},[t._v("filter")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    q "),a("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" q"),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("from_self"),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("self"),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("break_column"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),a("span",{attrs:{class:"token keyword"}},[t._v("if")]),t._v(" self"),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("window_size "),a("span",{attrs:{class:"token operator"}},[t._v(">")]),t._v(" "),a("span",{attrs:{class:"token number"}},[t._v("1")]),a("span",{attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n        q "),a("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" q"),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{attrs:{class:"token builtin"}},[t._v("filter")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token string"}},[t._v('"rownum %% %d=1"')]),t._v(" "),a("span",{attrs:{class:"token operator"}},[t._v("%")]),t._v(" self"),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("window_size"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),a("span",{attrs:{class:"token keyword"}},[t._v("return")]),t._v(" q\n")])])])},function(){var t=this.$createElement,s=this._self._c||t;return s("h3",{attrs:{id:"the-resulting-sql-with-and-without-a-filter-widget-example"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#the-resulting-sql-with-and-without-a-filter-widget-example","aria-hidden":"true"}},[this._v("#")]),this._v(" The resulting SQL with and without a filter (Widget example)")])},function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("div",{staticClass:"language-python extra-class"},[a("pre",{pre:!0,attrs:{class:"language-python"}},[a("code",[t._v("table_filter "),a("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" Widget"),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{attrs:{class:"token builtin"}},[t._v("id")]),t._v(" "),a("span",{attrs:{class:"token operator"}},[t._v("<")]),t._v(" "),a("span",{attrs:{class:"token number"}},[t._v("5000")]),t._v("\n")])])])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[s("strong",[this._v("SQL statement with filter")])])},function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("div",{staticClass:"language-sql extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sql"}},[a("code",[a("span",{attrs:{class:"token keyword"}},[t._v("SELECT")]),t._v(" anon_1"),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("widget_id \n"),a("span",{attrs:{class:"token keyword"}},[t._v("FROM")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("\n    "),a("span",{attrs:{class:"token keyword"}},[t._v("SELECT")]),t._v(" widget"),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("id "),a("span",{attrs:{class:"token keyword"}},[t._v("AS")]),t._v(" widget_id"),a("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" row_number"),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{attrs:{class:"token keyword"}},[t._v("OVER")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token keyword"}},[t._v("ORDER")]),t._v(" "),a("span",{attrs:{class:"token keyword"}},[t._v("BY")]),t._v(" widget"),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("id"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{attrs:{class:"token keyword"}},[t._v("AS")]),t._v(" rownum \n    "),a("span",{attrs:{class:"token keyword"}},[t._v("FROM")]),t._v(" widget\n    "),a("span",{attrs:{class:"token keyword"}},[t._v("WHERE")]),t._v(" widget"),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("id "),a("span",{attrs:{class:"token operator"}},[t._v("<")]),t._v(" :id_1\n  "),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{attrs:{class:"token keyword"}},[t._v("AS")]),t._v(" anon_1\n"),a("span",{attrs:{class:"token keyword"}},[t._v("WHERE")]),t._v(" rownum "),a("span",{attrs:{class:"token operator"}},[t._v("%")]),t._v(" "),a("span",{attrs:{class:"token number"}},[t._v("1000")]),a("span",{attrs:{class:"token operator"}},[t._v("=")]),a("span",{attrs:{class:"token number"}},[t._v("1")]),t._v("\n")])])])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[s("strong",[this._v("SQL statement without filter")])])},function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("div",{staticClass:"language-sql extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sql"}},[a("code",[a("span",{attrs:{class:"token keyword"}},[t._v("SELECT")]),t._v(" anon_1"),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("widget_id \n"),a("span",{attrs:{class:"token keyword"}},[t._v("FROM")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("\n    "),a("span",{attrs:{class:"token keyword"}},[t._v("SELECT")]),t._v(" widget"),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("id "),a("span",{attrs:{class:"token keyword"}},[t._v("AS")]),t._v(" widget_id"),a("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" row_number"),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{attrs:{class:"token keyword"}},[t._v("OVER")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token keyword"}},[t._v("ORDER")]),t._v(" "),a("span",{attrs:{class:"token keyword"}},[t._v("BY")]),t._v(" widget"),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("id"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{attrs:{class:"token keyword"}},[t._v("AS")]),t._v(" rownum\n    "),a("span",{attrs:{class:"token keyword"}},[t._v("FROM")]),t._v(" widget\n  "),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{attrs:{class:"token keyword"}},[t._v("AS")]),t._v(" anon_1\n"),a("span",{attrs:{class:"token keyword"}},[t._v("WHERE")]),t._v(" rownum "),a("span",{attrs:{class:"token operator"}},[t._v("%")]),t._v(" "),a("span",{attrs:{class:"token number"}},[t._v("1000")]),a("span",{attrs:{class:"token operator"}},[t._v("=")]),a("span",{attrs:{class:"token number"}},[t._v("1")]),t._v("\n")])])])}],!1,null,null,null);e.options.__file="query-windowing-with-a-filter-criteria.md";s.default=e.exports}}]);