<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>File Handling with Regex | C# Interface port to Python</title>
    <meta name="description" content="C# Interface port to Python">
    
    
    <link rel="preload" href="/esrgo-python-documentation/assets/css/styles.08b8ebf7.css" as="style"><link rel="preload" href="/esrgo-python-documentation/assets/js/app.08b8ebf7.js" as="script"><link rel="preload" href="/esrgo-python-documentation/assets/js/12.db983685.js" as="script"><link rel="preload" href="/esrgo-python-documentation/assets/css/5.styles.92ce2759.css" as="style"><link rel="preload" href="/esrgo-python-documentation/assets/js/5.92ce2759.js" as="script"><link rel="prefetch" href="/esrgo-python-documentation/assets/css/1.styles.dacdc8f1.css"><link rel="prefetch" href="/esrgo-python-documentation/assets/js/1.dacdc8f1.js"><link rel="prefetch" href="/esrgo-python-documentation/assets/css/2.styles.6df4aee8.css"><link rel="prefetch" href="/esrgo-python-documentation/assets/js/2.6df4aee8.js"><link rel="prefetch" href="/esrgo-python-documentation/assets/css/3.styles.62e3bade.css"><link rel="prefetch" href="/esrgo-python-documentation/assets/js/3.62e3bade.js"><link rel="prefetch" href="/esrgo-python-documentation/assets/js/4.e0e8277f.js"><link rel="prefetch" href="/esrgo-python-documentation/assets/js/6.b3d7e6cd.js"><link rel="prefetch" href="/esrgo-python-documentation/assets/js/7.fcd4ff92.js"><link rel="prefetch" href="/esrgo-python-documentation/assets/js/8.3d242c4d.js"><link rel="prefetch" href="/esrgo-python-documentation/assets/js/9.234d134d.js"><link rel="prefetch" href="/esrgo-python-documentation/assets/js/10.fb3d3e85.js"><link rel="prefetch" href="/esrgo-python-documentation/assets/js/11.d1c152da.js"><link rel="prefetch" href="/esrgo-python-documentation/assets/js/13.542e130d.js"><link rel="prefetch" href="/esrgo-python-documentation/assets/js/14.bf07540b.js"><link rel="prefetch" href="/esrgo-python-documentation/assets/js/15.123c7fb9.js"><link rel="prefetch" href="/esrgo-python-documentation/assets/js/16.8c7136bb.js"><link rel="prefetch" href="/esrgo-python-documentation/assets/js/17.4bf3763a.js"><link rel="prefetch" href="/esrgo-python-documentation/assets/js/18.19d247d1.js"><link rel="prefetch" href="/esrgo-python-documentation/assets/js/19.a9221979.js">
    <link rel="stylesheet" href="/esrgo-python-documentation/assets/css/5.styles.92ce2759.css"><link rel="stylesheet" href="/esrgo-python-documentation/assets/css/styles.08b8ebf7.css"><link rel="stylesheet" href="/esrgo-python-documentation/assets/css/1.styles.dacdc8f1.css"><link rel="stylesheet" href="/esrgo-python-documentation/assets/css/2.styles.6df4aee8.css"><link rel="stylesheet" href="/esrgo-python-documentation/assets/css/3.styles.62e3bade.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/esrgo-python-documentation/" class="home-link router-link-active"><!----> <span class="site-name">C# Interface port to Python</span></a> <div class="links" style="max-width:nullpx;"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/esrgo-python-documentation/" class="nav-link">Overview</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">Domain Model</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/esrgo-python-documentation/domain-generation.html" class="nav-link">Domain Model Code Generation</a></li><li class="dropdown-item"><!----> <a href="/esrgo-python-documentation/serializing-objects.html" class="nav-link">Serializing Objects in Correct Order</a></li><li class="dropdown-item"><!----> <a href="/esrgo-python-documentation/initializing-model-classes.html" class="nav-link">Initializing Model Classes</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">Processing</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/esrgo-python-documentation/commands.html" class="nav-link">Commands</a></li><li class="dropdown-item"><!----> <a href="/esrgo-python-documentation/csv-processing.html" class="nav-link">CSV Processing</a></li><li class="dropdown-item"><!----> <a href="/esrgo-python-documentation/file-handling-with-regex.html" class="nav-link router-link-exact-active router-link-active">File Handling with Regex</a></li><li class="dropdown-item"><!----> <a href="/esrgo-python-documentation/logging-with-xml-serialization.html" class="nav-link">Logging with XML Serialization</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">SqlAlchemy</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/esrgo-python-documentation/extracting-data-with-sqlalchemy.html" class="nav-link">Extracting Data with SqlAlchemy ORM</a></li><li class="dropdown-item"><!----> <a href="/esrgo-python-documentation/query-windowing-with-sqlalchemy.html" class="nav-link">Query Windowing with SqlAlchemy ORM</a></li><li class="dropdown-item"><!----> <a href="/esrgo-python-documentation/query-windowing-with-a-filter-criteria.html" class="nav-link">Query Windowing with a Filter Criteria</a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/esrgo-python-documentation/" class="nav-link">Overview</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">Domain Model</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/esrgo-python-documentation/domain-generation.html" class="nav-link">Domain Model Code Generation</a></li><li class="dropdown-item"><!----> <a href="/esrgo-python-documentation/serializing-objects.html" class="nav-link">Serializing Objects in Correct Order</a></li><li class="dropdown-item"><!----> <a href="/esrgo-python-documentation/initializing-model-classes.html" class="nav-link">Initializing Model Classes</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">Processing</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/esrgo-python-documentation/commands.html" class="nav-link">Commands</a></li><li class="dropdown-item"><!----> <a href="/esrgo-python-documentation/csv-processing.html" class="nav-link">CSV Processing</a></li><li class="dropdown-item"><!----> <a href="/esrgo-python-documentation/file-handling-with-regex.html" class="nav-link router-link-exact-active router-link-active">File Handling with Regex</a></li><li class="dropdown-item"><!----> <a href="/esrgo-python-documentation/logging-with-xml-serialization.html" class="nav-link">Logging with XML Serialization</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">SqlAlchemy</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/esrgo-python-documentation/extracting-data-with-sqlalchemy.html" class="nav-link">Extracting Data with SqlAlchemy ORM</a></li><li class="dropdown-item"><!----> <a href="/esrgo-python-documentation/query-windowing-with-sqlalchemy.html" class="nav-link">Query Windowing with SqlAlchemy ORM</a></li><li class="dropdown-item"><!----> <a href="/esrgo-python-documentation/query-windowing-with-a-filter-criteria.html" class="nav-link">Query Windowing with a Filter Criteria</a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><div class="sidebar-group first"><p class="sidebar-heading open"><span>File Handling with Regex</span> <!----></p> <ul class="sidebar-group-items"><li><a href="/esrgo-python-documentation/file-handling-with-regex.html#overview" class="sidebar-link">Overview</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/esrgo-python-documentation/file-handling-with-regex.html#file-naming-protocol" class="sidebar-link">File Naming Protocol</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/esrgo-python-documentation/file-handling-with-regex.html#regex-filename-parsing" class="sidebar-link">Regex Filename Parsing</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/esrgo-python-documentation/file-handling-with-regex.html#list-comprehension" class="sidebar-link">List Comprehension</a></li><li class="sidebar-sub-header"><a href="/esrgo-python-documentation/file-handling-with-regex.html#includes-and-excludes" class="sidebar-link">Includes and Excludes</a></li></ul></li></ul></div></li></ul> </div> <div class="page"> <div class="content"><h1 id="file-handling-with-regex"><a href="#file-handling-with-regex" aria-hidden="true" class="header-anchor">#</a> File Handling with Regex</h1> <h2 id="overview"><a href="#overview" aria-hidden="true" class="header-anchor">#</a> Overview</h2> <p>Files are downloaded from the FTP server to a LOCAL/IN directory on a daily basis. This component has the responsibility of scanning the Inbound file directory for files to process. It picks up files matching the prescribed naming pattern, and decides which to include or exclude from further processing.</p> <h2 id="file-naming-protocol"><a href="#file-naming-protocol" aria-hidden="true" class="header-anchor">#</a> File Naming Protocol</h2> <p>The files are named according to a naming convention which includes the following attributes:</p> <ul><li><p>Organisation identifying number (VPD)</p></li> <li><p>File type indicator - full snapshot or delta changes</p></li> <li><p>Date of file generation</p></li> <li><p>Sequence number of file</p></li> <li><p>Files in process of being written have an additional suffix</p></li></ul> <h2 id="regex-filename-parsing"><a href="#regex-filename-parsing" aria-hidden="true" class="header-anchor">#</a> Regex Filename Parsing</h2> <p>A regular expression is used to filter the list of files. Regex named groups are the key to converting the file name string into a strongly type object:</p> <div class="language-regex extra-class"><pre class="language-text"><code>&quot;(XX_(?P&lt;vpd&gt;[0-9]{3})_YYY_(?P&lt;type&gt;FT[F,C,R])_(?P&lt;date&gt;[0-9]{8})_(?P&lt;seqno&gt;[0-9]{8}).DAT(_prog)?)$&quot;
</code></pre></div><h3 id="list-comprehension"><a href="#list-comprehension" aria-hidden="true" class="header-anchor">#</a> List Comprehension</h3> <p>A list comprehension iterates the files in list for files obtained with the glob.glob library function.
The projection (product) of the list comprehension is a  CsvFileName object, where the constructor is passed the values of the regex named groups. A filter condition limits the output to only where there is a group match in the file name.</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">def</span> <span class="token function">_get_files_in_directory</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
    filename_regex <span class="token operator">=</span> <span class="token string">&quot;(XX_(?P&lt;vpd&gt;[0-9]{3})_YYY_(?P&lt;type&gt;FT[F,C,R])_(?P&lt;date&gt;[0-9]{8})_(?P&lt;seqno&gt;[0-9]{8}).DAT(_prog)?)$&quot;</span>
    regex <span class="token operator">=</span> re<span class="token punctuation">.</span><span class="token builtin">compile</span><span class="token punctuation">(</span>esr_filename_regex<span class="token punctuation">)</span>
    <span class="token builtin">list</span> <span class="token operator">=</span> glob<span class="token punctuation">.</span>glob<span class="token punctuation">(</span>self<span class="token punctuation">.</span>directory <span class="token operator">+</span> <span class="token string">&quot;/*&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token punctuation">[</span>CsvFileName<span class="token punctuation">(</span>g<span class="token punctuation">.</span>group<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> g<span class="token punctuation">.</span>group<span class="token punctuation">(</span><span class="token string">'vpd'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> g<span class="token punctuation">.</span>group<span class="token punctuation">(</span><span class="token string">'type'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> g<span class="token punctuation">.</span>group<span class="token punctuation">(</span><span class="token string">'date'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> g<span class="token punctuation">.</span>group<span class="token punctuation">(</span><span class="token string">'seqno'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">for</span> f <span class="token keyword">in</span> <span class="token builtin">list</span>
            <span class="token keyword">for</span> g <span class="token keyword">in</span> <span class="token punctuation">[</span>regex<span class="token punctuation">.</span>search<span class="token punctuation">(</span>f<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token keyword">if</span> g<span class="token punctuation">]</span>
</code></pre></div><p>The following screenshots show the regular expression tested in regex101.com</p> <figure><img src="/esrgo-python-documentation/assets/img/regex1.cfda03f8.png" alt="regex1"> <figcaption><i>(click to enlarge)</i></figcaption></figure> <figure><img src="/esrgo-python-documentation/assets/img/regex2.a0035988.png" alt="regex2"> <figcaption><i>(click to enlarge)</i></figcaption></figure> <h3 id="includes-and-excludes"><a href="#includes-and-excludes" aria-hidden="true" class="header-anchor">#</a> Includes and Excludes</h3> <ul><li><p>The files found with Regex are further filtered into Include and Exclude lists if</p></li> <li><p>They have the the wrong VPD number</p></li> <li><p>They have the in-progress suffix</p></li> <li><p>They have a sequence number preceding the last processed</p></li> <li><p>Any delta file which precedes a full snapshot file is irrelevant</p></li></ul> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">def</span> <span class="token function">_get_excludes_for_wrong_vpd</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
    self<span class="token punctuation">.</span>_get_excludes<span class="token punctuation">(</span><span class="token keyword">lambda</span> x<span class="token punctuation">:</span> x<span class="token punctuation">.</span>vpd <span class="token operator">!=</span> self<span class="token punctuation">.</span>vpd<span class="token punctuation">,</span> <span class="token string">&quot;Incorrect VPD code&quot;</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">_get_excludes_for_in_transfer_process</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
    self<span class="token punctuation">.</span>_get_excludes<span class="token punctuation">(</span><span class="token keyword">lambda</span> x<span class="token punctuation">:</span> x<span class="token punctuation">.</span>file_name<span class="token punctuation">.</span>endswith<span class="token punctuation">(</span><span class="token string">&quot;_txfr&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;In process of transferring&quot;</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">_get_excludes_for_precedes_last_sequence</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
    self<span class="token punctuation">.</span>_get_excludes<span class="token punctuation">(</span><span class="token keyword">lambda</span> x<span class="token punctuation">:</span> x<span class="token punctuation">.</span>sequence_number <span class="token operator">&lt;=</span> self<span class="token punctuation">.</span>last_sequence_number_processed<span class="token punctuation">,</span>
                       <span class="token string">&quot;Precedes sequence number from last run&quot;</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">_get_excludes_for_changes_preceding_full_file</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> <span class="token operator">not</span> self<span class="token punctuation">.</span>has_full_file<span class="token punctuation">:</span>
        <span class="token keyword">return</span>
    self<span class="token punctuation">.</span>_get_excludes<span class="token punctuation">(</span><span class="token keyword">lambda</span> x<span class="token punctuation">:</span> x<span class="token punctuation">.</span>sequence_number <span class="token operator">&lt;</span> self<span class="token punctuation">.</span>full_file<span class="token punctuation">.</span>sequence_number<span class="token punctuation">,</span>
                       <span class="token string">&quot;Precedes sequence number of full file&quot;</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">_get_excludes</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> func<span class="token punctuation">,</span> description<span class="token punctuation">)</span><span class="token punctuation">:</span>
    excludes <span class="token operator">=</span> <span class="token punctuation">[</span>self<span class="token punctuation">.</span>_set_excluded_reason<span class="token punctuation">(</span>f<span class="token punctuation">,</span> description<span class="token punctuation">)</span>
                <span class="token keyword">for</span> f <span class="token keyword">in</span> self<span class="token punctuation">.</span>files_included
                <span class="token keyword">if</span> func<span class="token punctuation">(</span>f<span class="token punctuation">)</span><span class="token punctuation">]</span>
    self<span class="token punctuation">.</span>_adjust_include_exclude_lists<span class="token punctuation">(</span>excludes<span class="token punctuation">)</span>

@<span class="token builtin">staticmethod</span>
<span class="token keyword">def</span> <span class="token function">_set_excluded_reason</span><span class="token punctuation">(</span>excluded_file<span class="token punctuation">,</span> reason<span class="token punctuation">)</span><span class="token punctuation">:</span>
    excluded_file<span class="token punctuation">.</span>reason_excluded <span class="token operator">=</span> reason
    <span class="token keyword">return</span> excluded_file
</code></pre></div><h4 id="lambda-expressions-for-exclude-evaluation"><a href="#lambda-expressions-for-exclude-evaluation" aria-hidden="true" class="header-anchor">#</a> Lambda Expressions for Exclude Evaluation</h4> <p>As there is a bit of repetition in the various exclude checking functions, a lambda expression is used to define the predicate for each case, and is passed in to a common function. The lambda expression captures class attribute values which are in it’s enclosing scope, such as self.vpd.</p> <div class="minimap-container" style="width:250px;" data-v-5674b532><div class="minimap" style="top:250px;zoom:25%;" data-v-5674b532><div data-v-5674b532></div></div></div></div> <div class="page-edit"><!----> <!----></div> <!----> </div> <!----></div></div>
    <script src="/esrgo-python-documentation/assets/js/12.db983685.js" defer></script><script src="/esrgo-python-documentation/assets/js/5.92ce2759.js" defer></script><script src="/esrgo-python-documentation/assets/js/app.08b8ebf7.js" defer></script>
  </body>
</html>
